{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/app/actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { emotionalAICopilot } from '@/ai/flows/emotional-ai-copilot';\r\nimport { personalizedObjectives, PersonalizedObjectivesInput } from '@/ai/flows/personalize-daily-objectives';\r\nimport { youtubeSearchFlow } from '@/ai/flows/youtube-search-flow';\r\nimport { runFlow } from '@genkit-ai/flow';\r\nimport type { ConversationState, Message } from '@/lib/types';\r\nimport prisma from '@/lib/prisma';\r\nimport { cookies } from 'next/headers';\r\n\r\n/**\r\n * Helper to save message to DB (mimics backend logic)\r\n */\r\nasync function saveMessageToDb(sessionId: string, role: 'user' | 'model', content: string) {\r\n  try {\r\n    if (!sessionId) return;\r\n\r\n    const sessionExists = await prisma.chatSession.findUnique({\r\n        where: { id: sessionId },\r\n        select: { id: true }\r\n    });\r\n\r\n    if (!sessionExists) {\r\n        return; \r\n    }\r\n\r\n    const count = await prisma.chatMessage.count({ where: { sessionId } });\r\n    await prisma.chatMessage.create({\r\n      data: {\r\n        sessionId,\r\n        role,\r\n        content,\r\n        timestamp: new Date(),\r\n        messageNumber: count + 1,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    // console.error('Error saving message to DB:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to update session state and title\r\n */\r\nasync function updateSessionState(sessionId: string, state: ConversationState, topic?: string, title?: string) {\r\n  if (!sessionId) return;\r\n  \r\n  // üîç LOGGING: Checking what we are trying to save\r\n  console.log(`[ACTION LOG] Attempting DB Update. ID: ${sessionId}, Title: \"${title}\"`);\r\n\r\n  const data: any = { updatedAt: new Date(), metadata: state };\r\n  \r\n  // ‚úÖ UPDATE TITLE IF PROVIDED\r\n  if (title && title !== \"New Chat\") {\r\n      data.topic = title; // Map 'title' to 'topic' column\r\n  }\r\n  \r\n  // UPDATE INTERNAL TOPIC (If separate from title)\r\n  if (topic && !title) {\r\n      data.topic = topic;\r\n  }\r\n  \r\n  await prisma.chatSession.update({\r\n    where: { id: sessionId },\r\n    data,\r\n  });\r\n}\r\n\r\n// FETCH MEMORY HELPER\r\nasync function fetchStudentMemory() {\r\n  try {\r\n    return { progress: [], mistakes: [] };\r\n  } catch (e) {\r\n    return { progress: [], mistakes: [] };\r\n  }\r\n}\r\n\r\nexport async function getAssistantResponse(\r\n  sessionId: string,\r\n  message: string,\r\n  chatHistory: Message[],\r\n  currentState: ConversationState,\r\n  fileDataBase64: { type: string; base64: string } | undefined,\r\n  forceWebSearch: boolean,\r\n  includeVideos: boolean,\r\n  preferences: {\r\n    name?: string;\r\n    gradeLevel?: 'Primary' | 'LowerSecondary' | 'UpperSecondary';\r\n    preferredLanguage?: 'english' | 'swahili' | 'arabic' | 'english_sw';\r\n    interests?: string[];\r\n  },\r\n  studentMemory: {\r\n    progress: any[];\r\n    mistakes: any[];\r\n  }\r\n) {\r\n  try {\r\n    // 1. Save User Message (Safely)\r\n    if (sessionId) {\r\n        await saveMessageToDb(sessionId, 'user', message);\r\n    }\r\n\r\n    // ‚úÖ FETCH CURRENT TITLE TO PASS TO AI\r\n    // This allows the AI to know if it needs to generate a title (if current is 'New Chat')\r\n    let currentTitle = 'New Chat';\r\n    if (sessionId) {\r\n        try {\r\n            const currentSession = await prisma.chatSession.findUnique({\r\n                where: { id: sessionId },\r\n                select: { topic: true }\r\n            });\r\n            if (currentSession?.topic) {\r\n                currentTitle = currentSession.topic;\r\n            }\r\n        } catch (e) {\r\n            // Ignore DB read error, default to New Chat\r\n        }\r\n    }\r\n\r\n    // 2. Run AI\r\n    console.log(\"[ACTION LOG] Calling Emotional AI...\");\r\n    const response = await emotionalAICopilot({\r\n      text: message,\r\n      chatHistory: chatHistory,\r\n      state: currentState,\r\n      preferences: preferences,\r\n      fileData: fileDataBase64,\r\n      forceWebSearch,\r\n      includeVideos,\r\n      memory: studentMemory,\r\n      currentTitle: currentTitle,\r\n      studentProfile: {\r\n        name: preferences.name || 'Student', // Ensure name is passed\r\n        gradeLevel: preferences.gradeLevel || 'Primary' // Ensure grade is passed\r\n      }\r\n    });\r\n\r\n    console.log(`[ACTION LOG] AI Finished. Suggested Title: \"${response.suggestedTitle}\"`);\r\n\r\n    // 3. Save AI Response & Try Update Title\r\n    if (sessionId) {\r\n        await saveMessageToDb(sessionId, 'model', response.processedText);\r\n        \r\n        // üõ°Ô∏è CRITICAL FIX: TRY/CATCH AROUND DB UPDATE\r\n        try {\r\n            await updateSessionState(\r\n                sessionId, \r\n                response.state, \r\n                response.topic, \r\n                response.suggestedTitle \r\n            );\r\n        } catch (dbError) {\r\n            console.warn(\"‚ö†Ô∏è [ACTION LOG] DB Write Failed (RLS/Auth). Returning title to Client for fallback save.\");\r\n        }\r\n    }\r\n\r\n    return {\r\n      processedText: response.processedText,\r\n      videoData: response.videoData ?? undefined,\r\n      state: response.state,\r\n      // ‚úÖ VITAL FIX: Pass suggestedTitle as 'topic' so frontend detects it\r\n      topic: response.suggestedTitle || response.topic,\r\n      suggestedTitle: response.suggestedTitle \r\n    };\r\n  } catch (err) {\r\n    console.error('[SERVER ACTION FATAL ERROR]', err);\r\n    return {\r\n      processedText: 'I am sorry, but something went wrong while processing that. Could you try again?',\r\n      videoData: undefined,\r\n      state: currentState,\r\n      topic: undefined,\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getDailyObjectives(\r\n  studentPerformance: string,\r\n  curriculum: string,\r\n  loggedMisconceptions: string\r\n) {\r\n  try {\r\n    const objectivesInput: PersonalizedObjectivesInput = {\r\n      studentPerformance,\r\n      curriculum,\r\n      loggedMisconceptions,\r\n    };\r\n    const result = await personalizedObjectives(objectivesInput);\r\n    return result.dailyObjectives;\r\n  } catch (err) {\r\n    console.error('[SERVER ACTION BRIDGE ERROR - Objectives]', err);\r\n    return ['Review today\\'s key concepts.', 'Practice one core problem.'];\r\n  }\r\n}\r\n\r\nexport async function searchYouTube(query: string) {\r\n  try {\r\n    const results = await runFlow(youtubeSearchFlow, { query });\r\n    return results;\r\n  } catch (error) {\r\n    console.error('[SERVER ACTION BRIDGE ERROR - YouTube]', error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport type { ConversationState, Message };"],"names":[],"mappings":";;;;;;IA+KsB,qBAAA,WAAA,GAAA,CAAA,GAAA,yNAAA,CAAA,wBAAA,EAAA,8CAAA,yNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,yNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/components/daily-objectives.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';\r\nimport { Loader2, Check, Sparkles } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { getDailyObjectives } from '@/app/actions';\r\nimport type { DailyObjective } from '@/lib/types';\r\n\r\nexport function DailyObjectives() {\r\n    const { toast } = useToast();\r\n    const [objectives, setObjectives] = useState<DailyObjective[]>([]);\r\n    const [isLoadingObjectives, setIsLoadingObjectives] = useState(true);\r\n\r\n    useEffect(() => {\r\n        async function fetchObjectives() {\r\n          setIsLoadingObjectives(true);\r\n          try {\r\n            // TODO: Replace with actual dynamic data from student's profile or backend\r\n            const studentPerformance = 'Student is excelling in basic algebra but struggles with word problems and applying concepts.';\r\n            const curriculum = 'Today‚Äôs lesson is on applying linear equations to real-world scenarios.';\r\n            const loggedMisconceptions = 'Difficulty in translating written descriptions into mathematical equations.';\r\n\r\n            const fetchedObjectives = await getDailyObjectives(studentPerformance, curriculum, loggedMisconceptions);\r\n            setObjectives(\r\n              fetchedObjectives.map((q, i) => ({\r\n                id: `obj-${i}`,\r\n                description: q, // Changed from 'question' to 'description'\r\n                completed: false // Changed from 'isCompleted' to 'completed'\r\n              }))\r\n            );\r\n          } catch (e) {\r\n            toast({\r\n              variant: \"destructive\",\r\n              title: \"Error\",\r\n              description: \"Could not load daily objectives.\",\r\n            });\r\n          } finally {\r\n            setIsLoadingObjectives(false);\r\n          }\r\n        }\r\n        fetchObjectives();\r\n    }, [toast]);\r\n    \r\n    const toggleObjective = (id: string) => {\r\n        setObjectives(objectives.map(obj => obj.id === id ? {...obj, completed: !obj.completed} : obj)); // Changed from 'isCompleted' to 'completed'\r\n    };\r\n\r\n    return (\r\n        <Card className=\"mb-8\">\r\n            <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2 text-xl\">\r\n                    <Sparkles className=\"h-6 w-6 text-accent\" /> Your Daily Objectives\r\n                </CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n            {isLoadingObjectives ? (\r\n                <div className=\"flex items-center gap-2 text-muted-foreground\"><Loader2 className=\"h-4 w-4 animate-spin\"/>Loading objectives...</div>\r\n            ) : (\r\n                <ul className=\"space-y-3\">\r\n                    {objectives.map(obj => (\r\n                        <li key={obj.id} className=\"flex items-start gap-3\">\r\n                            <button onClick={() => toggleObjective(obj.id)} className=\"mt-1 flex-shrink-0\">\r\n                                <div className={cn(\"h-5 w-5 rounded-full border-2 flex items-center justify-center transition-all\", obj.completed ? 'border-primary bg-primary' : 'border-muted-foreground')}>\r\n                                    {obj.completed && <Check className=\"h-3 w-3 text-primary-foreground\" />}\r\n                                </div>\r\n                            </button>\r\n                            <span className={cn(\"flex-1 text-sm text-muted-foreground\", obj.completed && \"line-through\")}>{obj.description}</span>\r\n                        </li>\r\n                    ))}\r\n                </ul>\r\n            )}\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;;;AARA;;;;;;;AAWO,SAAS;;IACZ,MAAM,EAAE,KAAK,EAAE,GAAG,CAAA,GAAA,oIAAA,CAAA,WAAQ,AAAD;IACzB,MAAM,CAAC,YAAY,cAAc,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAoB,EAAE;IACjE,MAAM,CAAC,qBAAqB,uBAAuB,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAE;IAE/D,CAAA,GAAA,6JAAA,CAAA,YAAS,AAAD;qCAAE;YACN,eAAe;gBACb,uBAAuB;gBACvB,IAAI;oBACF,2EAA2E;oBAC3E,MAAM,qBAAqB;oBAC3B,MAAM,aAAa;oBACnB,MAAM,uBAAuB;oBAE7B,MAAM,oBAAoB,MAAM,CAAA,GAAA,0JAAA,CAAA,qBAAkB,AAAD,EAAE,oBAAoB,YAAY;oBACnF,cACE,kBAAkB,GAAG;qEAAC,CAAC,GAAG,IAAM,CAAC;gCAC/B,IAAI,CAAC,IAAI,EAAE,GAAG;gCACd,aAAa;gCACb,WAAW,MAAM,4CAA4C;4BAC/D,CAAC;;gBAEL,EAAE,OAAO,GAAG;oBACV,MAAM;wBACJ,SAAS;wBACT,OAAO;wBACP,aAAa;oBACf;gBACF,SAAU;oBACR,uBAAuB;gBACzB;YACF;YACA;QACJ;oCAAG;QAAC;KAAM;IAEV,MAAM,kBAAkB,CAAC;QACrB,cAAc,WAAW,GAAG,CAAC,CAAA,MAAO,IAAI,EAAE,KAAK,KAAK;gBAAC,GAAG,GAAG;gBAAE,WAAW,CAAC,IAAI,SAAS;YAAA,IAAI,OAAO,4CAA4C;IACjJ;IAEA,qBACI,6LAAC,wIAAA,CAAA,OAAI;QAAC,WAAU;;0BACZ,6LAAC,wIAAA,CAAA,aAAU;0BACP,cAAA,6LAAC,wIAAA,CAAA,YAAS;oBAAC,WAAU;;sCACjB,6LAAC,6MAAA,CAAA,WAAQ;4BAAC,WAAU;;;;;;wBAAwB;;;;;;;;;;;;0BAGpD,6LAAC,wIAAA,CAAA,cAAW;0BACX,oCACG,6LAAC;oBAAI,WAAU;;sCAAgD,6LAAC,oNAAA,CAAA,UAAO;4BAAC,WAAU;;;;;;wBAAwB;;;;;;yCAE1G,6LAAC;oBAAG,WAAU;8BACT,WAAW,GAAG,CAAC,CAAA,oBACZ,6LAAC;4BAAgB,WAAU;;8CACvB,6LAAC;oCAAO,SAAS,IAAM,gBAAgB,IAAI,EAAE;oCAAG,WAAU;8CACtD,cAAA,6LAAC;wCAAI,WAAW,CAAA,GAAA,qHAAA,CAAA,KAAE,AAAD,EAAE,iFAAiF,IAAI,SAAS,GAAG,8BAA8B;kDAC7I,IAAI,SAAS,kBAAI,6LAAC,uMAAA,CAAA,QAAK;4CAAC,WAAU;;;;;;;;;;;;;;;;8CAG3C,6LAAC;oCAAK,WAAW,CAAA,GAAA,qHAAA,CAAA,KAAE,AAAD,EAAE,wCAAwC,IAAI,SAAS,IAAI;8CAAkB,IAAI,WAAW;;;;;;;2BANzG,IAAI,EAAE;;;;;;;;;;;;;;;;;;;;;AAcvC;GAlEgB;;QACM,oIAAA,CAAA,WAAQ;;;KADd","debugId":null}}]
}