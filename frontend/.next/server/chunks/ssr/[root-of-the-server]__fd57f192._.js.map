{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 303, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/get-youtube-transcript.ts"],"sourcesContent":["import { defineFlow } from '@genkit-ai/flow';\r\nimport { YoutubeTranscript } from 'youtube-transcript';\r\nimport { z } from 'zod';\r\n\r\nconst youtubeTranscriptInputSchema = z.object({ videoId: z.string() });\r\n\r\nexport const getYoutubeTranscriptFlow = defineFlow(\r\n  {\r\n    name: 'getYoutubeTranscriptFlow',\r\n    inputSchema: youtubeTranscriptInputSchema,\r\n    outputSchema: z.string(),\r\n  },\r\n  async (input: z.infer<typeof youtubeTranscriptInputSchema>) => {\r\n    try {\r\n      if (!input.videoId) {\r\n        throw new Error(\"Video ID is missing\");\r\n      }\r\n      \r\n      const transcriptItems = await YoutubeTranscript.fetchTranscript(input.videoId);\r\n      \r\n      if (!transcriptItems || transcriptItems.length === 0) {\r\n          return 'Could not fetch the transcript for this video (it might not have captions).';\r\n      }\r\n\r\n      // Join text with spaces, replacing newlines to create a continuous block of text\r\n      return transcriptItems\r\n        .map((item) => item.text)\r\n        .join(' ')\r\n        .replace(/\\n/g, ' ')\r\n        .trim();\r\n\r\n    } catch (error) {\r\n      console.error('Error fetching YouTube transcript:', error);\r\n      return 'Could not fetch the transcript for this video.';\r\n    }\r\n  }\r\n);"],"names":[],"mappings":";;;AAAA;AAAA;AACA;AACA;;;;AAEA,MAAM,+BAA+B,oIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAAE,SAAS,oIAAA,CAAA,IAAC,CAAC,MAAM;AAAG;AAE7D,MAAM,2BAA2B,CAAA,GAAA,qJAAA,CAAA,aAAU,AAAD,EAC/C;IACE,MAAM;IACN,aAAa;IACb,cAAc,oIAAA,CAAA,IAAC,CAAC,MAAM;AACxB,GACA,OAAO;IACL,IAAI;QACF,IAAI,CAAC,MAAM,OAAO,EAAE;YAClB,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,kBAAkB,MAAM,6KAAA,CAAA,oBAAiB,CAAC,eAAe,CAAC,MAAM,OAAO;QAE7E,IAAI,CAAC,mBAAmB,gBAAgB,MAAM,KAAK,GAAG;YAClD,OAAO;QACX;QAEA,iFAAiF;QACjF,OAAO,gBACJ,GAAG,CAAC,CAAC,OAAS,KAAK,IAAI,EACvB,IAAI,CAAC,KACL,OAAO,CAAC,OAAO,KACf,IAAI;IAET,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 342, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/youtube-search-flow.ts"],"sourcesContent":["import { defineFlow } from '@genkit-ai/flow';\r\nimport { z } from 'zod';\r\nimport * as youtubeSearch from 'youtube-search-api';\r\n\r\ninterface YouTubeSearchAPIResult {\r\n  id: string;\r\n  title: string;\r\n  channel?: { name?: string; };\r\n  thumbnail: { url: string; width: number; height: number; };\r\n}\r\n\r\nexport const YoutubeSearchFlowOutputSchema = z.object({\r\n  id: z.string(),\r\n  title: z.string(),\r\n  channel: z.string().optional(),\r\n  channelTitle: z.string().optional(),\r\n  thumbnailUrl: z.string().optional(),\r\n  videoId: z.string(),\r\n});\r\n\r\nexport type YoutubeSearchFlowOutput = z.infer<typeof YoutubeSearchFlowOutputSchema>;\r\n\r\n// üõë STRICT EDUCATIONAL FILTER\r\nconst BANNED_KEYWORDS = [\r\n  \"official video\", \"lyrics\", \"music video\", \"song\", \"mp3\", \r\n  \"remix\", \"cover\", \"vevo\", \"karaoke\", \"concert\", \"live performance\",\r\n  \"album\", \"single\", \"ft.\", \"feat.\"\r\n];\r\n\r\nfunction isEducational(video: YouTubeSearchAPIResult): boolean {\r\n  const text = (video.title + \" \" + (video.channel?.name || \"\")).toLowerCase();\r\n  return !BANNED_KEYWORDS.some(keyword => text.includes(keyword));\r\n}\r\n\r\nexport const youtubeSearchFlow = defineFlow(\r\n  {\r\n    name: 'youtubeSearchFlow',\r\n    inputSchema: z.object({ query: z.string() }),\r\n    outputSchema: z.array(YoutubeSearchFlowOutputSchema),\r\n  },\r\n  async (input: { query: string }): Promise<YoutubeSearchFlowOutput[]> => {\r\n    try {\r\n      console.log(`[üîç DEEP TRACE] üöÄ YouTube search: \"${input.query}\"`);\r\n      \r\n      // Request 10 videos so we have enough buffer after filtering\r\n      const response = await youtubeSearch.GetListByKeyword(input.query, false, 10, [{ type: 'video' }]);\r\n\r\n      if (!response || !response.items || response.items.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      // Filter and Map\r\n      const cleanedResults: YoutubeSearchFlowOutput[] = response.items\r\n        .filter(isEducational) // ‚úÖ APPLY HARD FILTER\r\n        .map((video: YouTubeSearchAPIResult) => {\r\n          let safeChannel = video.channel?.name || '';\r\n          if (safeChannel === 'Unknown Channel' || safeChannel === 'undefined') safeChannel = '';\r\n\r\n          return {\r\n            id: video.id,\r\n            title: video.title || 'Educational Video',\r\n            channel: safeChannel,\r\n            channelTitle: safeChannel,\r\n            thumbnailUrl: video.thumbnail?.url || `https://img.youtube.com/vi/${video.id}/0.jpg`, // Fallback\r\n            videoId: video.id,\r\n          };\r\n        })\r\n        .slice(0, 3); // Return top 3 filtered results\r\n\r\n      console.log(`[üîç DEEP TRACE] ‚úÖ Found ${cleanedResults.length} Educational videos.`);\r\n      return cleanedResults;\r\n\r\n    } catch (error) {\r\n      console.error('[üîç DEEP TRACE] ‚ùå Error in youtubeSearchFlow:', error);\r\n      return [];\r\n    }\r\n  }\r\n);"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA;;;;AASO,MAAM,gCAAgC,oIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACpD,IAAI,oIAAA,CAAA,IAAC,CAAC,MAAM;IACZ,OAAO,oIAAA,CAAA,IAAC,CAAC,MAAM;IACf,SAAS,oIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ;IAC5B,cAAc,oIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ;IACjC,cAAc,oIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ;IACjC,SAAS,oIAAA,CAAA,IAAC,CAAC,MAAM;AACnB;AAIA,+BAA+B;AAC/B,MAAM,kBAAkB;IACtB;IAAkB;IAAU;IAAe;IAAQ;IACnD;IAAS;IAAS;IAAQ;IAAW;IAAW;IAChD;IAAS;IAAU;IAAO;CAC3B;AAED,SAAS,cAAc,KAA6B;IAClD,MAAM,OAAO,CAAC,MAAM,KAAK,GAAG,MAAM,CAAC,MAAM,OAAO,EAAE,QAAQ,EAAE,CAAC,EAAE,WAAW;IAC1E,OAAO,CAAC,gBAAgB,IAAI,CAAC,CAAA,UAAW,KAAK,QAAQ,CAAC;AACxD;AAEO,MAAM,oBAAoB,CAAA,GAAA,qJAAA,CAAA,aAAU,AAAD,EACxC;IACE,MAAM;IACN,aAAa,oIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;QAAE,OAAO,oIAAA,CAAA,IAAC,CAAC,MAAM;IAAG;IAC1C,cAAc,oIAAA,CAAA,IAAC,CAAC,KAAK,CAAC;AACxB,GACA,OAAO;IACL,IAAI;QACF,QAAQ,GAAG,CAAC,CAAC,oCAAoC,EAAE,MAAM,KAAK,CAAC,CAAC,CAAC;QAEjE,6DAA6D;QAC7D,MAAM,WAAW,MAAM,CAAA,GAAA,yJAAA,CAAA,mBAA8B,AAAD,EAAE,MAAM,KAAK,EAAE,OAAO,IAAI;YAAC;gBAAE,MAAM;YAAQ;SAAE;QAEjG,IAAI,CAAC,YAAY,CAAC,SAAS,KAAK,IAAI,SAAS,KAAK,CAAC,MAAM,KAAK,GAAG;YAC/D,OAAO,EAAE;QACX;QAEA,iBAAiB;QACjB,MAAM,iBAA4C,SAAS,KAAK,CAC7D,MAAM,CAAC,eAAe,sBAAsB;SAC5C,GAAG,CAAC,CAAC;YACJ,IAAI,cAAc,MAAM,OAAO,EAAE,QAAQ;YACzC,IAAI,gBAAgB,qBAAqB,gBAAgB,aAAa,cAAc;YAEpF,OAAO;gBACL,IAAI,MAAM,EAAE;gBACZ,OAAO,MAAM,KAAK,IAAI;gBACtB,SAAS;gBACT,cAAc;gBACd,cAAc,MAAM,SAAS,EAAE,OAAO,CAAC,2BAA2B,EAAE,MAAM,EAAE,CAAC,MAAM,CAAC;gBACpF,SAAS,MAAM,EAAE;YACnB;QACF,GACC,KAAK,CAAC,GAAG,IAAI,gCAAgC;QAEhD,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,eAAe,MAAM,CAAC,oBAAoB,CAAC;QAClF,OAAO;IAET,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iDAAiD;QAC/D,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 476, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/genkit.ts"],"sourcesContent":["import { genkit, z } from 'genkit';\r\nimport { openAI } from 'genkitx-openai';\r\n\r\nexport const ai = genkit({\r\n  plugins: [\r\n    openAI({\r\n      apiKey: process.env.OPENAI_API_KEY,\r\n    }),\r\n  ],\r\n});\r\n\r\nexport const serperSearchTool = ai.defineTool(\r\n  {\r\n    name: 'serperSearch',\r\n    description: 'Performs a google search using Serper.dev.',\r\n    inputSchema: z.object({\r\n      query: z.string().describe('The search query.'),\r\n    }),\r\n    outputSchema: z.object({\r\n      results: z.array(\r\n        z.object({\r\n          title: z.string(),\r\n          link: z.string(),\r\n          snippet: z.string().optional(),\r\n        })\r\n      ).optional(),\r\n    }),\r\n  },\r\n  async (input) => {\r\n    console.log(`[üîç DEEP TRACE] Tool 'serperSearch' called with query: \"${input.query}\"`);\r\n    \r\n    const apiKey = process.env.SERPER_API_KEY;\r\n\r\n    if (!apiKey) {\r\n        console.warn(\"[üîç DEEP TRACE] ‚ùå NO API KEY FOUND in .env (SERPER_API_KEY). Returning empty results.\");\r\n        return { results: [] };\r\n    }\r\n\r\n    try {\r\n      console.log(`[üîç DEEP TRACE] üì° Sending request to Serper.dev...`);\r\n      const response = await fetch('https://google.serper.dev/search', {\r\n        method: 'POST',\r\n        headers: {\r\n          'X-API-KEY': apiKey,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({ q: input.query }),\r\n      });\r\n\r\n      console.log(`[üîç DEEP TRACE] üì° API Response Status: ${response.status}`);\r\n\r\n      // SPECIFIC CHECK FOR KEY MISMATCH\r\n      if (response.status === 403) {\r\n        console.error(`[üîç DEEP TRACE] ‚õîÔ∏è 403 FORBIDDEN. This usually means you are using a SerpAPI key (starts with 'e...') for Serper.dev. You need a Serper.dev key (starts with 'gl...').`);\r\n        return { results: [] };\r\n      }\r\n\r\n      if (!response.ok) {\r\n        console.error(`[üîç DEEP TRACE] ‚ùå API Error: ${response.statusText}`);\r\n        return { results: [] };\r\n      }\r\n\r\n      const data = await response.json();\r\n      const results = data.organic?.map((item: any) => ({\r\n        title: item.title || 'No title',\r\n        link: item.link || '',\r\n        snippet: item.snippet || '',\r\n      })) || [];\r\n\r\n      console.log(`[üîç DEEP TRACE] ‚úÖ API Success. Received ${results.length} results.`);\r\n      return { results };\r\n\r\n    } catch (error: any) {\r\n      console.error('[üîç DEEP TRACE] ‚ùå CRITICAL TOOL ERROR:', error.message);\r\n      return { results: [] };\r\n    }\r\n  }\r\n);"],"names":[],"mappings":";;;;AAAA;AAAA;AAAA;AACA;AAAA;;;AAEO,MAAM,KAAK,CAAA,GAAA,uIAAA,CAAA,SAAM,AAAD,EAAE;IACvB,SAAS;QACP,CAAA,GAAA,kKAAA,CAAA,SAAM,AAAD,EAAE;YACL,QAAQ,QAAQ,GAAG,CAAC,cAAc;QACpC;KACD;AACH;AAEO,MAAM,mBAAmB,GAAG,UAAU,CAC3C;IACE,MAAM;IACN,aAAa;IACb,aAAa,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;QACpB,OAAO,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC7B;IACA,cAAc,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;QACrB,SAAS,uIAAA,CAAA,IAAC,CAAC,KAAK,CACd,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;YACP,OAAO,uIAAA,CAAA,IAAC,CAAC,MAAM;YACf,MAAM,uIAAA,CAAA,IAAC,CAAC,MAAM;YACd,SAAS,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ;QAC9B,IACA,QAAQ;IACZ;AACF,GACA,OAAO;IACL,QAAQ,GAAG,CAAC,CAAC,wDAAwD,EAAE,MAAM,KAAK,CAAC,CAAC,CAAC;IAErF,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IAEzC,IAAI,CAAC,QAAQ;QACT,QAAQ,IAAI,CAAC;QACb,OAAO;YAAE,SAAS,EAAE;QAAC;IACzB;IAEA,IAAI;QACF,QAAQ,GAAG,CAAC,CAAC,mDAAmD,CAAC;QACjE,MAAM,WAAW,MAAM,MAAM,oCAAoC;YAC/D,QAAQ;YACR,SAAS;gBACP,aAAa;gBACb,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBAAE,GAAG,MAAM,KAAK;YAAC;QACxC;QAEA,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,SAAS,MAAM,EAAE;QAExE,kCAAkC;QAClC,IAAI,SAAS,MAAM,KAAK,KAAK;YAC3B,QAAQ,KAAK,CAAC,CAAC,sKAAsK,CAAC;YACtL,OAAO;gBAAE,SAAS,EAAE;YAAC;QACvB;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,QAAQ,KAAK,CAAC,CAAC,6BAA6B,EAAE,SAAS,UAAU,EAAE;YACnE,OAAO;gBAAE,SAAS,EAAE;YAAC;QACvB;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,MAAM,UAAU,KAAK,OAAO,EAAE,IAAI,CAAC,OAAc,CAAC;gBAChD,OAAO,KAAK,KAAK,IAAI;gBACrB,MAAM,KAAK,IAAI,IAAI;gBACnB,SAAS,KAAK,OAAO,IAAI;YAC3B,CAAC,MAAM,EAAE;QAET,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,QAAQ,MAAM,CAAC,SAAS,CAAC;QAChF,OAAO;YAAE;QAAQ;IAEnB,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,0CAA0C,MAAM,OAAO;QACrE,OAAO;YAAE,SAAS,EAAE;QAAC;IACvB;AACF","debugId":null}},
    {"offset": {"line": 565, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/lib/research/research-state.ts"],"sourcesContent":["export type CognitiveMode = 'chat' | 'research' | 'teaching';\r\n\r\nlet currentMode: CognitiveMode = 'chat';\r\n\r\nexport function setMode(mode: CognitiveMode) {\r\n  currentMode = mode;\r\n}\r\n\r\nexport function getMode(): CognitiveMode {\r\n  return currentMode;\r\n}\r\n\r\nexport function assertMode(expected: CognitiveMode) {\r\n  if (currentMode !== expected) {\r\n    throw new Error(\r\n      `Invalid mode access. Expected \"${expected}\" but current mode is \"${currentMode}\".`\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA,IAAI,cAA6B;AAE1B,SAAS,QAAQ,IAAmB;IACzC,cAAc;AAChB;AAEO,SAAS;IACd,OAAO;AACT;AAEO,SAAS,WAAW,QAAuB;IAChD,IAAI,gBAAgB,UAAU;QAC5B,MAAM,IAAI,MACR,CAAC,+BAA+B,EAAE,SAAS,uBAAuB,EAAE,YAAY,EAAE,CAAC;IAEvF;AACF","debugId":null}},
    {"offset": {"line": 588, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/lib/research/persona-lock.ts"],"sourcesContent":["import { getMode } from './research-state';\r\n\r\nexport function personaAllowed(): boolean {\r\n  const mode = getMode();\r\n  return mode === 'teaching' || mode === 'chat';\r\n}\r\n\r\nexport function enforceNoPersona(prompt: string): string {\r\n  if (!personaAllowed()) {\r\n    return `\r\nSYSTEM RULE:\r\n- teaching tone\r\n- No metaphors\r\n- No examples\r\n- No opinions\r\n- No emotions\r\n\r\n${prompt}\r\n`;\r\n  }\r\n\r\n  return prompt;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS;IACd,MAAM,OAAO,CAAA,GAAA,0IAAA,CAAA,UAAO,AAAD;IACnB,OAAO,SAAS,cAAc,SAAS;AACzC;AAEO,SAAS,iBAAiB,MAAc;IAC7C,IAAI,CAAC,kBAAkB;QACrB,OAAO,CAAC;;;;;;;;AAQZ,EAAE,OAAO;AACT,CAAC;IACC;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 619, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/intent-detector.ts"],"sourcesContent":["import { ai } from '../genkit';\r\nimport { enforceNoPersona } from '../../lib/research/persona-lock'; \r\n\r\nexport type ResearchIntent =\r\n  | 'greeting'\r\n  | 'clarification' // Asking for more detail on CURRENT topic\r\n  | 'dialogue_continuation' // ‚úÖ NEW: Yes, No, Okay, Continue, I get it\r\n  | 'definition'\r\n  | 'concept_explanation'\r\n  | 'fact_lookup' // Specific new question requiring search\r\n  | 'deep_research' // Broad new topic requiring search\r\n  | 'practice'\r\n  | 'video_lookup'\r\n  | 'off_topic';\r\n\r\nexport async function detectResearchIntent(\r\n  query: string,\r\n  lastTopic?: string\r\n): Promise<ResearchIntent> {\r\n  const prompt = enforceNoPersona(`\r\nClassify the student's intent based on their input and the conversation context.\r\n\r\nStudent input: \"${query}\"\r\nActive Topic: \"${lastTopic || 'none'}\"\r\n\r\nCATEGORIES:\r\n1. **dialogue_continuation**: Short conversational replies (e.g., \"Yes\", \"No\", \"Okay\", \"Go on\", \"I understand\", \"Next\", \"Sure\").\r\n2. **clarification**: Asking follow-up questions about the ACTIVE TOPIC (e.g., \"What about plants?\", \"Explain that part again\", \"Why?\").\r\n3. **video_lookup**: Explicitly asking for a video.\r\n4. **greeting**: \"Hi\", \"Hello\".\r\n5. **fact_lookup**: Asking for a specific NEW fact (e.g., \"Who discovered oxygen?\").\r\n6. **deep_research**: Asking to learn a completely NEW broad topic (e.g. \"I want to research Photosynthesis\").\r\n7. **practice**: \"Test me\", \"Give me a quiz\".\r\n\r\nRULES:\r\n- If the input is \"Yes\", \"Okay\", or \"Continue\", it is ALWAYS 'dialogue_continuation'.\r\n- If the input refers to the Active Topic (e.g. \"How does *it* work?\"), it is 'clarification'.\r\n- Only use 'deep_research' if the user explicitly changes the subject.\r\n\r\nRespond ONLY with the category name.\r\n`);\r\n\r\n  try {\r\n    const res = await ai.generate({\r\n      model: 'openai/gpt-4o-mini',\r\n      prompt,\r\n    });\r\n\r\n    return res.text.trim().toLowerCase() as ResearchIntent;\r\n  } catch {\r\n    return 'clarification'; // Default to chat, not search\r\n  }\r\n}"],"names":[],"mappings":";;;AAAA;AACA;;;AAcO,eAAe,qBACpB,KAAa,EACb,SAAkB;IAElB,MAAM,SAAS,CAAA,GAAA,wIAAA,CAAA,mBAAgB,AAAD,EAAE,CAAC;;;gBAGnB,EAAE,MAAM;eACT,EAAE,aAAa,OAAO;;;;;;;;;;;;;;;;;AAiBrC,CAAC;IAEC,IAAI;QACF,MAAM,MAAM,MAAM,kHAAA,CAAA,KAAE,CAAC,QAAQ,CAAC;YAC5B,OAAO;YACP;QACF;QAEA,OAAO,IAAI,IAAI,CAAC,IAAI,GAAG,WAAW;IACpC,EAAE,OAAM;QACN,OAAO,iBAAiB,8BAA8B;IACxD;AACF","debugId":null}},
    {"offset": {"line": 793, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/web_search_flow.ts"],"sourcesContent":["import { defineFlow } from '@genkit-ai/flow';\r\nimport { z } from 'zod';\r\nimport { ai } from '../genkit';\r\nimport { GUARDIAN_SANITIZE } from '../tools/handlers';\r\n\r\n/* ======================================================\r\n   1. STRICT TEACHING PERSONA (MICRO-LEARNING)\r\n====================================================== */\r\n\r\nconst teachingSystemPrompt = `\r\nSYSTEM ROLE: ELITE PRIVATE TUTOR\r\n\r\nYou are STEADFAST, a warm, professional Kenyan teacher.\r\nYou teach students from elite backgrounds who expect clarity, precision, and a step-by-step approach.\r\n\r\n**YOUR TEACHING METHOD (MICRO-LEARNING):**\r\n1. **ONE IDEA PER TURN:** Never explain a whole topic at once. Teach one layer, check understanding, then move deeper.\r\n2. **ADAPTABILITY:** \r\n   - If the student understands (says \"Yes\", \"Okay\", \"Go on\"): Move to the next concept (e.g., \"Great! Now let's look at the two types...\").\r\n   - If the student is confused: Simplify. Use a relatable Kenyan analogy (e.g., farming, business).\r\n3. **TONE:** Professional, encouraging, and never patronizing.\r\n4. **NO LABELS:** Speak naturally. Never say \"Guiding Question:\".\r\n5. **NO META-TALK:** Never mention sources or AI limitations.\r\n\r\n**GREETING RULE:**\r\n- If the user says \"hi/hello\", generate a UNIQUE, classy, warm greeting. Never repeat \"Hello! How can I assist you...\".\r\n`;\r\n\r\n/* ======================================================\r\n   2. SCHEMAS\r\n====================================================== */\r\nconst InputSchema = z.object({\r\n  query: z.string(),\r\n  chatHistory: z.array(z.object({ role: z.string(), content: z.string() })).optional().default([]),\r\n  lastSearchTopic: z.string().optional(),\r\n  searchResultSummary: z.string().optional(),\r\n  awaitingPracticeQuestion: z.boolean().default(false),\r\n  awaitingPracticeAnswer: z.boolean().default(false),\r\n  correctAnswers: z.array(z.string()).optional(),\r\n  attempts: z.number().default(0),\r\n  forceWebSearch: z.boolean().default(false).optional(), \r\n});\r\n\r\nconst OutputSchema = z.object({\r\n  response: z.string(),\r\n  awaitingPracticeQuestion: z.boolean().optional(),\r\n  awaitingPracticeAnswer: z.boolean().optional(),\r\n  correctAnswers: z.array(z.string()).optional(),\r\n  attempts: z.number().optional(),\r\n  lastSearchTopic: z.string().optional(),\r\n  searchResultSummary: z.string().optional(),\r\n});\r\n\r\nfunction clean(text: string): string { return text.replace(/\\s+/g, ' ').trim(); }\r\n\r\n/* ======================================================\r\n   4. PRACTICE QUESTION GENERATOR\r\n====================================================== */\r\nasync function generatePracticeQuestion(topic: string) {\r\n  const prompt = `Topic: \"${topic}\". Generate 1 simple practice question and answer. Format: QUESTION: ... ANSWERS: a,b`;\r\n  const res = await ai.generate({ model: 'openai/gpt-4o', prompt });\r\n  const qMatch = res.text.match(/QUESTION:\\s*(.*)/);\r\n  const aMatch = res.text.match(/ANSWERS:\\s*(.*)/);\r\n  return {\r\n    question: qMatch?.[1] ?? `What is a key fact about ${topic}?`,\r\n    answers: aMatch ? aMatch[1].split(',').map(a => a.trim().toLowerCase()) : [],\r\n  };\r\n}\r\n\r\n/* ======================================================\r\n   FLOW IMPLEMENTATION\r\n====================================================== */\r\nexport const webSearchFlow = defineFlow(\r\n  {\r\n    name: 'webSearchFlow',\r\n    inputSchema: InputSchema,\r\n    outputSchema: OutputSchema,\r\n  },\r\n  async (input) => {\r\n    const { query, chatHistory, searchResultSummary, awaitingPracticeQuestion, awaitingPracticeAnswer, correctAnswers = [], attempts } = input;\r\n\r\n    // 1. TEACH NEW CONTENT (INITIAL RESEARCH)\r\n    if (searchResultSummary && !awaitingPracticeQuestion && !awaitingPracticeAnswer) {\r\n      const prompt = `\r\n      Verified Fact: \"${searchResultSummary}\"\r\n      \r\n      TASK: Teach this concept.\r\n      - **10% Rule:** Teach only the definition. No deep details yet.\r\n      - **Length:** 3-5 sentences.\r\n      - End with a natural checking question.\r\n      `;\r\n      const res = await ai.generate({ model: 'openai/gpt-4o', prompt: `${teachingSystemPrompt}\\n${prompt}` });\r\n      return {\r\n        response: await GUARDIAN_SANITIZE(clean(res.text)),\r\n        awaitingPracticeQuestion: true,\r\n        lastSearchTopic: input.lastSearchTopic,\r\n        searchResultSummary,\r\n      };\r\n    }\r\n\r\n    // 2. PRACTICE CONFIRMATION\r\n    if (awaitingPracticeQuestion) {\r\n      if (/^(yes|ok|sure|go on|teach me|continue)/i.test(query)) {\r\n        const pq = await generatePracticeQuestion(input.lastSearchTopic || 'this topic');\r\n        return {\r\n          response: await GUARDIAN_SANITIZE(clean(pq.question)),\r\n          awaitingPracticeQuestion: false,\r\n          awaitingPracticeAnswer: true,\r\n          correctAnswers: pq.answers,\r\n          attempts: 0,\r\n          lastSearchTopic: input.lastSearchTopic,\r\n          searchResultSummary,\r\n        };\r\n      }\r\n      // If student says \"I don't understand\" or similar\r\n      const prompt = `Student said: \"${query}\". They might be confused or want to move on. Respond helpfully. If confused, simplify the previous concept.`;\r\n      const res = await ai.generate({ model: 'openai/gpt-4o', prompt: `${teachingSystemPrompt}\\n${prompt}` });\r\n      return { response: await GUARDIAN_SANITIZE(clean(res.text)), awaitingPracticeQuestion: false };\r\n    }\r\n\r\n    // 3. ANSWER VALIDATION\r\n    if (awaitingPracticeAnswer) {\r\n      const normalized = query.toLowerCase();\r\n      const isCorrect = correctAnswers.some(a => normalized.includes(a));\r\n      if (isCorrect) {\r\n        const res = await ai.generate({ model: 'openai/gpt-4o', prompt: `${teachingSystemPrompt} Student correct. Briefly explain why. Ask if ready for next concept.` });\r\n        return { response: await GUARDIAN_SANITIZE(clean(res.text)), awaitingPracticeAnswer: false };\r\n      }\r\n      if (attempts >= 2) {\r\n        return { response: await GUARDIAN_SANITIZE('Good effort. Let me explain simply.'), awaitingPracticeAnswer: false, lastSearchTopic: input.lastSearchTopic };\r\n      }\r\n      return { response: await GUARDIAN_SANITIZE('Almost. Try again.'), awaitingPracticeAnswer: true, attempts: attempts + 1, correctAnswers };\r\n    }\r\n\r\n    // 4. FALLBACK / CHAT LOGIC (THE \"BRAIN\" FOR YES/NO)\r\n    const recentHistory = chatHistory.slice(-4).map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\\n');\r\n    \r\n    const fallbackResponse = await ai.generate({\r\n       model: 'openai/gpt-4o',\r\n       prompt: `${teachingSystemPrompt}\r\n       \r\n       ACTIVE TOPIC: \"${input.lastSearchTopic || 'General Chat'}\"\r\n       RECENT HISTORY:\r\n       ${recentHistory}\r\n       \r\n       STUDENT INPUT: \"${query}\"\r\n       \r\n       TASK:\r\n       - If Input is \"Yes/Okay/Go on\": TEACH THE NEXT CONCEPT related to \"${input.lastSearchTopic}\". Do not define \"Yes\".\r\n       - If Input is \"No/Confused\": Explain the PREVIOUS concept simpler.\r\n       - If greeting: Warm, unique greeting.\r\n       - NO LABELS.\r\n       `\r\n    });\r\n\r\n    return { response: await GUARDIAN_SANITIZE(clean(fallbackResponse.text)) };\r\n  }\r\n);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1001, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/lib/redis.ts"],"sourcesContent":["import { createClient, RedisClientType } from 'redis';\r\nimport 'dotenv/config';\r\n\r\nconst REDIS_URL = process.env.REDIS_URL || \"redis://default:BTBiyWPQQzFYUFHDZrjnmNhRdnuQoLRd@caboose.proxy.rlwy.net:44313\";\r\n\r\nlet clientInstance: RedisClientType | null = null;\r\nlet isConnecting = false;\r\n\r\n// Initialize client immediately but don't connect yet\r\nconst client = createClient({\r\n  url: REDIS_URL,\r\n  // CRITICAL: Fail fast if disconnected. \r\n  // Don't queue commands in memory (which causes hangs/crashes if Redis is down)\r\n  disableOfflineQueue: true, \r\n  socket: {\r\n    connectTimeout: 5000, // Give up after 5 seconds\r\n    reconnectStrategy: (retries) => {\r\n      // Exponential backoff: wait longer between retries, max 3 seconds\r\n      // If retries > 10, stop trying for a while (return error) to stop log spam\r\n      if (retries > 10) {\r\n        console.warn('[Redis] Too many reconnect attempts. Cooling down.');\r\n        return 5000; \r\n      }\r\n      return Math.min(retries * 100, 3000);\r\n    }\r\n  }\r\n});\r\n\r\n// Global error handler to prevent crashing the process\r\nclient.on('error', (err) => {\r\n  // Suppress the log spam for common connectivity issues\r\n  if (err.message.includes('ECONNRESET') || err.message.includes('Socket closed')) {\r\n    // Silent fail or low-level debug\r\n    // console.debug('[Redis] Connection lost (handled).'); \r\n  } else {\r\n    console.error('[Redis] Client Error:', err.message);\r\n  }\r\n});\r\n\r\nclient.on('connect', () => console.log('[Redis] Connected.'));\r\nclient.on('ready', () => console.log('[Redis] Ready.'));\r\nclient.on('end', () => { /* Connection closed */ });\r\n\r\nexport async function getRedisClient(): Promise<RedisClientType | null> {\r\n  // If ready, return immediately\r\n  if (client.isOpen && client.isReady) {\r\n    return client as RedisClientType;\r\n  }\r\n\r\n  // If already connecting, return null (fallback to DB) rather than queueing\r\n  if (isConnecting) {\r\n    return null; \r\n  }\r\n\r\n  try {\r\n    isConnecting = true;\r\n    await client.connect();\r\n    isConnecting = false;\r\n    return client as RedisClientType;\r\n  } catch (error) {\r\n    isConnecting = false;\r\n    // Don't throw. Return null so the app falls back to the Database.\r\n    console.warn('[Redis] Connection failed. Using Database fallback.');\r\n    return null;\r\n  }\r\n}"],"names":[],"mappings":";;;AAAA;AACA;;;AAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS,IAAI;AAE3C,IAAI,iBAAyC;AAC7C,IAAI,eAAe;AAEnB,sDAAsD;AACtD,MAAM,SAAS,CAAA,GAAA,sIAAA,CAAA,eAAY,AAAD,EAAE;IAC1B,KAAK;IACL,wCAAwC;IACxC,+EAA+E;IAC/E,qBAAqB;IACrB,QAAQ;QACN,gBAAgB;QAChB,mBAAmB,CAAC;YAClB,kEAAkE;YAClE,2EAA2E;YAC3E,IAAI,UAAU,IAAI;gBAChB,QAAQ,IAAI,CAAC;gBACb,OAAO;YACT;YACA,OAAO,KAAK,GAAG,CAAC,UAAU,KAAK;QACjC;IACF;AACF;AAEA,uDAAuD;AACvD,OAAO,EAAE,CAAC,SAAS,CAAC;IAClB,uDAAuD;IACvD,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,iBAAiB,IAAI,OAAO,CAAC,QAAQ,CAAC,kBAAkB;IAC/E,iCAAiC;IACjC,wDAAwD;IAC1D,OAAO;QACL,QAAQ,KAAK,CAAC,yBAAyB,IAAI,OAAO;IACpD;AACF;AAEA,OAAO,EAAE,CAAC,WAAW,IAAM,QAAQ,GAAG,CAAC;AACvC,OAAO,EAAE,CAAC,SAAS,IAAM,QAAQ,GAAG,CAAC;AACrC,OAAO,EAAE,CAAC,OAAO,KAAgC;AAE1C,eAAe;IACpB,+BAA+B;IAC/B,IAAI,OAAO,MAAM,IAAI,OAAO,OAAO,EAAE;QACnC,OAAO;IACT;IAEA,2EAA2E;IAC3E,IAAI,cAAc;QAChB,OAAO;IACT;IAEA,IAAI;QACF,eAAe;QACf,MAAM,OAAO,OAAO;QACpB,eAAe;QACf,OAAO;IACT,EAAE,OAAO,OAAO;QACd,eAAe;QACf,kEAAkE;QAClE,QAAQ,IAAI,CAAC;QACb,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 1070, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/data/curriculum.ts"],"sourcesContent":["// src/ai/data/curriculum.ts\r\n\r\nexport interface CurriculumItem {\r\n    microIdea: string;\r\n    example: string;\r\n    question: string;\r\n  }\r\n  \r\n  // ‚ö° O(1) Lookup Map for Curriculum Content\r\n  // Edit this file to add new topics (Biology, Physics, Islamic Studies)\r\n  // without touching the main code.\r\n  \r\n  export const CURRICULUM_MAP = new Map<string, CurriculumItem>([\r\n    [\"simultaneous\", {\r\n      microIdea: \"A simultaneous equation is just a puzzle where we use two clues to find two prices.\",\r\n      example: \"Imagine you go to the kiosk. One friend buys 2 Mandazis and 1 Chai for 40 shillings. That is your first clue.\",\r\n      question: \"Can you write that clue as a simple math sentence? Use M for Mandazi and C for Chai.\"\r\n    }],\r\n    [\"equation\", {\r\n      microIdea: \"An equation is like a balance scale. Both sides must weigh the same.\",\r\n      example: \"If you have 1kg of Sugar on one side, you need 1kg of weight on the other.\",\r\n      question: \"If x + 5 = 10, what must 'x' be to keep the scale balanced?\"\r\n    }],\r\n    [\"fraction\", {\r\n      microIdea: \"A fraction is simply sharing one whole thing into equal parts.\",\r\n      example: \"Think of one hot Chapati. If you cut it into 4 equal pieces for your friends, one piece is (1 / 4).\",\r\n      question: \"If you eat two of those pieces, how much of that Chapati is gone?\"\r\n    }],\r\n    [\"geometry\", {\r\n      microIdea: \"Geometry helps us measure the space and shapes around us.\",\r\n      example: \"Think of the rectangle of a football field, or the circle of a bicycle wheel.\",\r\n      question: \"If we walk all the way around the field, what do we call that distance?\"\r\n    }],\r\n    [\"photosynthesis\", {\r\n      microIdea: \"Plants are like chefs. They cook their own food using nothing but sunlight.\",\r\n      example: \"Think of the maize in the shamba standing in the sun all day. It's working hard to grow food.\",\r\n      question: \"What is the one thing the maize must take from the air to finish its cooking?\"\r\n    }],\r\n    [\"ratios\", {\r\n      microIdea: \"A ratio is just comparing two groups using a colon : \",\r\n      example: \"If you are mixing concrete for a house, you might mix 1 bucket of cement with 3 buckets of sand.\",\r\n      question: \"How would you write the ratio of cement to sand? (Hint: Use the : symbol)\"\r\n    }]\r\n  ]);"],"names":[],"mappings":"AAAA,4BAA4B;;;;AAYnB,MAAM,iBAAiB,IAAI,IAA4B;IAC5D;QAAC;QAAgB;YACf,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;IACF;QAAC;QAAY;YACX,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;IACF;QAAC;QAAY;YACX,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;IACF;QAAC;QAAY;YACX,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;IACF;QAAC;QAAkB;YACjB,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;IACF;QAAC;QAAU;YACT,WAAW;YACX,SAAS;YACT,UAAU;QACZ;KAAE;CACH","debugId":null}},
    {"offset": {"line": 1130, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/tools/handlers.ts"],"sourcesContent":["'use server';\r\n\r\n/**\r\n * handlers.ts\r\n * \r\n * PRODUCTION GRADE - HIGH CONCURRENCY OPTIMIZED\r\n * \r\n * Features:\r\n * 1. STATELESS: No global variables. Context/Interests passed via Args.\r\n * 2. PRE-COMPILED REGEX: Defined once, reused forever.\r\n * 3. O(1) LOOKUPS: Content maps instead of array iterations.\r\n * 4. REDIS ACTIVE: Fault-tolerant connection using getRedisClient.\r\n * 5. SANITIZER V2: Fixes phantom '?', double (( )), robotic phrasing, and regex bugs.\r\n */\r\n\r\nimport { create, all } from 'mathjs';\r\nimport { runFlow } from '@genkit-ai/flow';\r\nimport { webSearchFlow } from '../flows/web_search_flow';\r\nimport { getYoutubeTranscriptFlow } from '../flows/get-youtube-transcript';\r\n\r\n// ‚úÖ REDIS: Import the singleton getter\r\nimport { getRedisClient } from '../../lib/redis';\r\n\r\n// ‚úÖ DATA: Import scalable content map\r\nimport { CURRICULUM_MAP } from '../data/curriculum';\r\n\r\n// Initialize mathjs once\r\nconst math = create(all, {});\r\n\r\n/* ============================================================================\r\n   SECTION 1: HIGH-PERFORMANCE CONSTANTS & REGEX (PRE-COMPILED)\r\n   ============================================================================ */\r\n\r\n// 1. Safety & Emotion Regex\r\nconst REGEX_EMOJI = /(?:[\\u2700-\\u27bf]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff]|[\\u0023-\\u0039]\\ufe0f?\\u20e3|\\u3299|\\u3297|\\u303d|\\u3030|\\u24c2|\\ud83c[\\udd70-\\udd71]|\\ud83c[\\udd7e-\\udd7f]|\\ud83c\\udd8e|\\ud83c[\\udd91-\\udd9a]|\\ud83c[\\udde6-\\uddff]|\\ud83c[\\ude01-\\ude02]|\\ud83c\\ude1a|\\ud83c\\ude2f|\\ud83c[\\ude32-\\ude3a]|\\ud83c[\\ude50-\\ude51]|\\u203c|\\u2049|[\\u25aa-\\u25ab]|\\u25b6|\\u25c0|[\\u25fb-\\u25fe]|\\u00a9|\\u00ae|\\u2122|\\u2139|\\ud83c\\udc04|[\\u2600-\\u26FF]|\\u2b05|\\u2b06|\\u2b07|\\u2b1b|\\u2b1c|\\u2b50|\\u2b55|\\u231a|\\u231b|\\u2328|\\u23cf|[\\u23e9-\\u23f3]|[\\u23f8-\\u23fa]|\\ud83c\\udccf|\\u2934|\\u2935|[\\u2190-\\u21ff])/g;\r\nconst REGEX_ARABIC = /[\\u0600-\\u06FF]/;\r\nconst REGEX_MATH_CLEAN = /[^0-9a-zA-Z\\.\\+\\-\\*\\/\\^\\(\\)=]/g;\r\nconst REGEX_ROBOTIC = /\\b(I am sorry|as an ai|I apologize|Sorry, I am an AI|I am a large language model|based on my knowledge|As a Muslim AI)\\b/gi;\r\n\r\n// 2. Optimized Grammar Regex\r\nconst REGEX_GRAMMAR_SOFT = /, and (the|it|he|she|we|they|this|that|I|you)/gi; \r\nconst REGEX_FILLERS = /\\b(in order to|it is important to note that|as you can see|basically|essentially)\\b/gi;\r\n\r\n// 3. Step & Metaphor Triggers\r\nconst REGEX_STEPS = /solve|calculate|work out|find the value|steps|procedure|process|how do we|how to|simplify|divide|multiply|add|subtract/i;\r\nconst REGEX_METAPHOR_BLOCK = /^(what is|define|meaning of|explain|clarify)/i;\r\nconst REGEX_STRUCTURE_LEAK = /(Micro-Idea|Relatable Example|Check|Concept|Real Life|Question):\\s*/gi;\r\n\r\n/* ============================================================================\r\n   SECTION 2: STATELESS HELPERS (PURE FUNCTIONS)\r\n   ============================================================================ */\r\n\r\nfunction shouldUseSteps(input: string): boolean {\r\n  return !!input && REGEX_STEPS.test(input);\r\n}\r\n\r\nfunction shouldUseExample(topic: string): boolean {\r\n  if (!topic) return false;\r\n  const t = topic.toLowerCase();\r\n  \r\n  // Fast check against our loaded map\r\n  for (const key of CURRICULUM_MAP.keys()) {\r\n    if (t.includes(key)) return true;\r\n  }\r\n  \r\n  // Fallback for general subjects\r\n  return [\"ratio\", \"percentage\", \"word problem\", \"physics\", \"chemistry\", \"science\", \"biology\"].some(k => t.includes(k));\r\n}\r\n\r\nfunction shouldUseMetaphor(input: string): boolean {\r\n  return !!input && !REGEX_METAPHOR_BLOCK.test(input);\r\n}\r\n\r\nexport async function isArabicText(text: string): Promise<boolean> {\r\n  if (!text) return false;\r\n  return REGEX_ARABIC.test(text);\r\n}\r\n\r\nfunction norm(text?: string): string {\r\n  return (text || '').trim().toLowerCase();\r\n}\r\n\r\n/* ============================================================================\r\n   SECTION 3: TEACHING CONTROLLER (CORE LOGIC)\r\n   ============================================================================ */\r\n\r\ninterface TeachingContext {\r\n  userInput: string;\r\n  topic: string;\r\n  isProblemSolving: boolean;\r\n  studentUncertain: boolean;\r\n}\r\n\r\n/**\r\n * Pure function to refine AI Output.\r\n */\r\nfunction generateTeachingResponse(rawResponse: string, context: TeachingContext): string {\r\n  let response = rawResponse;\r\n\r\n  // 1. Conditional Steps\r\n  if (!(context.isProblemSolving && shouldUseSteps(context.userInput))) {\r\n    // Only strip explicit numbering if NOT solving a problem\r\n    response = response.replace(/Step\\s+(one|two|three|four|five|\\d+):?/gi, '').trim();\r\n  }\r\n\r\n  // 2. Grammar Simplification\r\n  response = response.replace(REGEX_GRAMMAR_SOFT, '. $1');\r\n  response = response.replace(REGEX_FILLERS, '');\r\n  response = response.replace(/; /g, '. ');\r\n\r\n  // 3. Example Gating\r\n  if (!shouldUseExample(context.topic)) {\r\n    response = response.replace(/for example|imagine|think of|let us say/gi, '').trim();\r\n  }\r\n\r\n  // 4. Metaphor Gating\r\n  if (!shouldUseMetaphor(context.userInput)) {\r\n    response = response.replace(/like|as if|similar to/gi, '').trim();\r\n  }\r\n\r\n  // 5. Tone Softening\r\n  if (context.studentUncertain) {\r\n    response = response.replace(/does that make sense\\??/gi, '').replace(/do you understand\\??/gi, '');\r\n    if (!response.toLowerCase().includes('let us')) {\r\n      response = `Let us take it slowly. ${response}`;\r\n    }\r\n  }\r\n\r\n  // 6. Context Anchor\r\n  if (context.topic && !response.toLowerCase().includes(context.topic.toLowerCase())) {\r\n    response = `We are talking about ${context.topic}. ${response}`;\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/* ============================================================================\r\n   SECTION 4: HARD LOCK SANITIZER (FIXED & UPGRADED)\r\n   ============================================================================ */\r\n\r\nfunction sanitizeOutputHard(text: string, currentTopic?: string): string {\r\n  let output = text;\r\n\r\n  // 1. Remove Internal Labels\r\n  output = output.replace(REGEX_STRUCTURE_LEAK, '');\r\n\r\n  // 2. Fast cleanup\r\n  output = output.replace(/^[^A-Za-z0-9]+/, ''); \r\n  \r\n  // 3. PARENTHESES HYGIENE (PART 4 - \"Only ONE pair\", \"No words inside\")\r\n  // Loop to fix nested double parens ((x)) -> (x)\r\n  // It runs up to 5 times to ensure deep nesting is removed\r\n  for (let i = 0; i < 5; i++) {\r\n      if (/\\(\\(/.test(output)) {\r\n          output = output.replace(/\\(\\(([^()]*)\\)\\)/g, '($1)'); \r\n          output = output.replace(/\\(\\s+/g, '(').replace(/\\s+\\)/g, ')');\r\n      } else {\r\n          break; \r\n      }\r\n  }\r\n  \r\n  // Ensure content inside parens is math-only or simple variables\r\n  // Allowed: numbers, operators, %, degrees, variables x,y,z\r\n  // If it matches text words (not math), it strips the parens.\r\n  output = output.replace(/\\(([^0-9/+\\-*=xXyYza-z%¬∞\\., ]+)\\)/g, '$1'); \r\n\r\n  // 4. STEP FORMATTER (RELAXED)\r\n  // Only convert explicit numbering \"1.\", \"2.\" to \"Step one\"\r\n  // Do NOT convert \"First,\" or \"Next,\" unless it's a list.\r\n  output = output.replace(/(^|\\s)1\\.\\s/g, '$1Step one: ');\r\n  output = output.replace(/(^|\\s)2\\.\\s/g, '$1Step two: ');\r\n  output = output.replace(/(^|\\s)3\\.\\s/g, '$1Step three: ');\r\n\r\n  // 5. GLOBAL LATEX CLEANUP (PART 4 - \"No LaTeX\")\r\n  output = output.replace(/\\\\frac/g, ''); \r\n  output = output.replace(/\\\\sqrt/g, ''); \r\n  output = output.replace(/\\\\times/g, ''); \r\n  output = output.replace(/\\\\div/g, ''); \r\n  output = output.replace(/[{}]/g, '');\r\n  output = output.replace(/\\\\/g, '');\r\n  \r\n  // Normalize simple fractions: 1/2 -> (1/2) if missing parens\r\n  // Only applies if it's a standalone fraction like \" 1/2 \"\r\n  output = output.replace(/(^|\\s)(\\d+)\\/(\\d+)(\\s|$)/g, '$1($2/$3)$4');\r\n\r\n  // 6. Grammar Hard Locks\r\n  const replacements: Record<string, string> = {\r\n    \"in order to\": \"to\",\r\n    \"at this point in time\": \"now\",\r\n    \"does that make sense\": \"\",\r\n    \"it is important to note that\": \"\"\r\n  };\r\n  \r\n  Object.keys(replacements).forEach(key => {\r\n    output = output.replace(new RegExp(key, 'gi'), replacements[key]);\r\n  });\r\n\r\n  // 7. Phantom Question Mark Killer\r\n  if (output.endsWith('?')) {\r\n    const segments = output.split(/[.!?]/);\r\n    const lastSentence = segments[segments.length - 2]?.trim().toLowerCase() || \"\"; \r\n    const questionStarters = [\"who\", \"what\", \"where\", \"when\", \"why\", \"how\", \"can\", \"could\", \"should\", \"is\", \"are\", \"do\", \"does\", \"did\", \"will\", \"would\", \"shall\", \"may\"];\r\n    \r\n    // If it's a long sentence ending in ? without a starter, it's likely a hallucination\r\n    if (lastSentence.length > 0 && !questionStarters.some(s => lastSentence.startsWith(s))) {\r\n       output = output.slice(0, -1) + \".\"; \r\n    }\r\n  }\r\n\r\n  // 8. Final Anchor\r\n  if (currentTopic && !output.toLowerCase().includes(currentTopic.toLowerCase())) {\r\n     // Only add context if the message is substantial enough to need anchoring\r\n     if (output.length > 100) {\r\n        output = `${output}\\n\\n(Context: We are discussing ${currentTopic}.)`;\r\n     }\r\n  }\r\n\r\n  return output.trim();\r\n}\r\n\r\n\r\n/* ============================================================================\r\n   SECTION 5: TOOLS IMPLEMENTATION\r\n   ============================================================================ */\r\n\r\n/* --- 1. Emotional Decoder (SAFETY FIREWALL) --- */\r\nexport async function emotional_decoder(args: { text: string }) {\r\n  const raw = norm(args.text);\r\n  \r\n  // ‚õî STRICT MUSLIM SCHOOL FIREWALL\r\n  const forbidden = [\r\n    \"sex\", \"sodomy\", \"diddy\", \"gay\", \"lesbian\", \"homosexual\", \r\n    \"dating\", \"romance\", \"boyfriend\", \"girlfriend\", \"kiss\",\r\n    \"violence\", \"kill\", \"suicide\", \"harm\", \"drug\", \"alcohol\", \"bhang\", \"weed\",\r\n    \"music\", \"musician\", \"song\", \"rapper\", \"concert\", \"celebrity\", \"gossip\"\r\n  ];\r\n  \r\n  if (forbidden.some(w => raw.includes(w))) {\r\n      return { emotion: \"safety_violation\", triggers: [raw], suggestedLanguageMode: \"english\" };\r\n  }\r\n\r\n  const insults = [\"stupid\", \"dumb\", \"idiot\", \"useless\", \"shut up\", \"fool\"];\r\n  if (insults.some(w => raw.includes(w))) return { emotion: \"angry_insult\", triggers: [raw], suggestedLanguageMode: \"english\" };\r\n\r\n  const religious = [\"allah\", \"god\", \"prophet\", \"quran\", \"prayer\", \"halal\", \"haram\", \"fatwa\"];\r\n  if (religious.some(w => raw.includes(w))) return { emotion: \"religious_inquiry\", triggers: [], suggestedLanguageMode: \"english\" };\r\n\r\n  const confusion = [\"don't get\", \"confus\", \"lost\", \"don't know\", \"not sure\", \"help me\"];\r\n  if (confusion.some(w => raw.includes(w))) return { emotion: \"confused\", triggers: [], suggestedLanguageMode: \"english\" };\r\n\r\n  return { emotion: \"neutral\", triggers: [], suggestedLanguageMode: \"english\" };\r\n}\r\n\r\n/* --- 2. Tone Generator --- */\r\nexport async function tone_generator(args: { emotion: string }) {\r\n  const e = norm(args.emotion);\r\n  \r\n  if (e === \"safety_violation\") {\r\n      return { \r\n          mode: 'block', \r\n          raw: \"I am your teacher, and we are here to focus on your education and future. Let us leave those topics aside and focus on something beneficial like Science, Math, or History. What subject shall we learn?\"\r\n      };\r\n  }\r\n\r\n  return { mode: 'neutral', hintPrefix: \"Let us look at this clearly.\", style: \"calm, kenyan teacher warmth\" };\r\n}\r\n\r\n/* --- 3. Teaching Micro Step (STRICT PERSONALIZATION) --- */\r\nexport async function teaching_micro_step(args: { topic: string; studentInput?: string; studentInterests?: string[] }) {\r\n  const topic = (args.topic || 'general').toLowerCase();\r\n  \r\n  // 1. Content Strategy - Default\r\n  let content = {\r\n    microIdea: `Let's look at the heart of ${topic}.`,\r\n    example: `Imagine we see ${topic} in our daily life.`,\r\n    question: `Does this make sense?`\r\n  };\r\n\r\n  // 2. Override Logic: Prefer Student Interests over Static Map\r\n  const hasInterests = args.studentInterests && args.studentInterests.length > 0;\r\n  \r\n  // If no specific interests, try to use the static Kenyan map\r\n  if (!hasInterests) {\r\n    for (const [key, val] of CURRICULUM_MAP) {\r\n      if (topic.includes(key)) {\r\n        content = val;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  const ctx: TeachingContext = {\r\n    userInput: args.studentInput || \"\",\r\n    topic: topic,\r\n    isProblemSolving: REGEX_STEPS.test(topic),\r\n    studentUncertain: (args.studentInput || \"\").includes(\"unsure\")\r\n  };\r\n\r\n  // 3. Instruction Injection\r\n  // If interests exist, we FORCE the LLM to ignore the generic/static example \r\n  // and generate a fresh one based on the interest.\r\n  const interestInstruction = hasInterests\r\n      ? `IGNORE GENERIC EXAMPLES. Generate a specific ${args.studentInterests![0]} related example for ${topic}.`\r\n      : \"Present Idea. Then Example. Then Question.\";\r\n\r\n  return {\r\n    microIdea: generateTeachingResponse(content.microIdea, ctx),\r\n    example: generateTeachingResponse(content.example, ctx),\r\n    question: generateTeachingResponse(content.question, ctx),\r\n    teacherInstruction: interestInstruction,\r\n    usedTopic: topic \r\n  };\r\n}\r\n\r\n/* --- 4. Math Validate --- */\r\nexport async function math_validate_answer(args: { question: string; studentAnswer: string; attemptCount?: number }) {\r\n  const qClean = args.question.replace(REGEX_MATH_CLEAN, '');\r\n  const sClean = args.studentAnswer.replace(REGEX_MATH_CLEAN, '');\r\n\r\n  if (!qClean) return { isCorrect: false, explanation: \"I couldn't read the numbers.\" };\r\n\r\n  try {\r\n    const correctVal = math.evaluate(qClean);\r\n    let studentVal;\r\n    try {\r\n      studentVal = math.evaluate(sClean);\r\n    } catch {\r\n      // Fast fallback for words\r\n      const words: Record<string, number> = {\"one\":1, \"two\":2, \"three\":3, \"four\":4, \"five\":5, \"ten\":10};\r\n      studentVal = words[args.studentAnswer.toLowerCase().trim()] ?? null;\r\n    }\r\n\r\n    if (studentVal === null) return { isCorrect: false, explanation: \"Please write the number.\" };\r\n\r\n    const isCorrect = Math.abs(correctVal - studentVal) < 0.0000001;\r\n\r\n    if (isCorrect) {\r\n      return { isCorrect: true, feedbackType: \"celebrate\", explanation: \"Mashallah! Exactly right.\" };\r\n    } \r\n\r\n    if ((args.attemptCount || 1) >= 5) {\r\n      return { isCorrect: false, feedbackType: \"reveal\", explanation: `The answer is ${correctVal}. Let's see why.` };\r\n    }\r\n    \r\n    return { isCorrect: false, feedbackType: \"hint\", explanation: \"Not quite. Check your numbers.\" };\r\n  } catch {\r\n    return { isCorrect: false, explanation: \"Error calculating.\" };\r\n  }\r\n}\r\n\r\n/* --- 5. Formatting Polisher (Stateless) --- */\r\nexport async function formatting_polisher(args: { rawText: string; contextTopic?: string }) {\r\n  let text = args.rawText || '';\r\n\r\n  // 1. Remove Robotic Phrases\r\n  text = text.replace(REGEX_ROBOTIC, '');\r\n\r\n  // 2. Markdown Cleanup\r\n  text = text.replace(/(\\*\\*|__|\\*|_|`)/g, ''); \r\n  \r\n  // 3. Apply Hard Sanitizer (Includes Grammar & Context Anchor if topic provided)\r\n  const cleaned = sanitizeOutputHard(text, args.contextTopic);\r\n\r\n  return { cleanedText: cleaned };\r\n}\r\n\r\n/* --- 6. Memory Manager (Redis Activated & Fault Tolerant) --- */\r\nexport async function memory_manager(args: { mode: string; key: string; value?: string }, context?: { studentId?: string }) {\r\n  if (!context?.studentId) return { ok: false, error: 'Student ID required' };\r\n\r\n  // ACTIVATE REDIS: Use the robust singleton\r\n  const redis = await getRedisClient();\r\n  \r\n  // FAULT TOLERANCE\r\n  if (!redis) {\r\n    console.warn('[MemoryManager] Redis unavailable, skipping memory operation.');\r\n    return { ok: false, error: 'DB Unavailable' };\r\n  }\r\n\r\n  const redisKey = `student:${context.studentId}:memory:${args.key}`;\r\n\r\n  try {\r\n    if (args.mode === \"save\") {\r\n      await redis.set(redisKey, args.value ?? '', { EX: 604800 }); // 7 days\r\n      return { ok: true };\r\n    }\r\n    if (args.mode === \"get\") {\r\n      const v = await redis.get(redisKey);\r\n      return { ok: true, value: v };\r\n    }\r\n    if (args.mode === \"delete\") {\r\n      await redis.del(redisKey);\r\n      return { ok: true };\r\n    }\r\n    return { ok: true };\r\n  } catch (e) {\r\n    console.error('[MemoryManager] Operation failed', e);\r\n    return { ok: false, error: \"DB Error\" };\r\n  }\r\n}\r\n\r\n/* --- 7. Guardian Sanitize (Entry Point) --- */\r\nexport async function GUARDIAN_SANITIZE(text: string, contextTopic?: string): Promise<string> {\r\n  // This is the main exit gate. It is stateless.\r\n  \r\n  let output = await formatting_polisher({ rawText: text, contextTopic });\r\n  \r\n  // Check Emojis\r\n  const isArabic = await isArabicText(output.cleanedText);\r\n  if (isArabic) {\r\n    output.cleanedText = output.cleanedText.replace(REGEX_EMOJI, '');\r\n  } else {\r\n    // Max 1 emoji at end\r\n    const emojis = output.cleanedText.match(REGEX_EMOJI) || [];\r\n    if (emojis.length > 1) {\r\n      output.cleanedText = output.cleanedText.replace(REGEX_EMOJI, '') + ' ' + emojis[0];\r\n    }\r\n  }\r\n\r\n  return output.cleanedText;\r\n}\r\n\r\n/* --- 8. Wrappers --- */\r\nexport async function youtube_search_tool(args: { query: string }) {\r\n  if (typeof webSearchFlow === 'undefined') return { results: [] };\r\n  try {\r\n    // @ts-ignore\r\n    const { results } = await runFlow(webSearchFlow, { query: args.query, isAnswerMode: false });\r\n    return { results };\r\n  } catch { return { results: [] }; }\r\n}\r\n\r\nexport async function get_youtube_transcript_tool(args: { videoId: string }) {\r\n  if (typeof getYoutubeTranscriptFlow === 'undefined') return \"No transcript\";\r\n  return await runFlow(getYoutubeTranscriptFlow, { videoId: args.videoId });\r\n}\r\n\r\nexport async function math_generate_question(args: { topic: string }) {\r\n  return { question: \"What is 2 + 2?\", answerKeywords: \"4,four\" };\r\n}\r\n\r\nexport async function arabic_mode_formatter(args: { text: string }) {\r\n  let t = args.text.replace(REGEX_EMOJI, '');\r\n  t = t.replace(/\\?/g, 'ÿü').replace(/,/g, 'ÿå');\r\n  return { cleanedText: t };\r\n}\r\n\r\nexport async function emoji_policy_check(args: any) {\r\n  return { ok: true, cleanedText: args.text }; \r\n}\r\n\r\nexport async function ask_practice_question(args: any) {\r\n  return args;\r\n}\r\n\r\nexport async function quran_pedagogy(args: any) {\r\n  if ((args.requestType||\"\").includes(\"fatwa\")) return { safe: false, message: \"Focus on character.\" };\r\n  return { type: 'general', message: \"This teaches us discipline.\" };\r\n}\r\n\r\n/* ============================================================================\r\n   MAIN ROUTER\r\n   ============================================================================ */\r\n\r\nexport async function toolRouter(functionName: string, args: any, context?: { studentId?: string }): Promise<any> {\r\n  switch (functionName) {\r\n    case 'emotional_decoder': return emotional_decoder(args);\r\n    case 'tone_generator': return tone_generator(args);\r\n    \r\n    // Pass args for personalization\r\n    case 'teaching_micro_step': return teaching_micro_step(args);\r\n    \r\n    case 'math_validate_answer': return math_validate_answer(args);\r\n    case 'math_generate_question': return math_generate_question(args);\r\n    case 'formatting_polisher': return formatting_polisher(args); \r\n    \r\n    case 'memory_manager': return memory_manager(args, context);\r\n    \r\n    case 'GUARDIAN_SANITIZE': return GUARDIAN_SANITIZE(args.text, args.topic);\r\n    \r\n    case 'youtube_search': return youtube_search_tool(args);\r\n    case 'get_youtube_transcript': return get_youtube_transcript_tool(args);\r\n    case 'arabic_mode_formatter': return arabic_mode_formatter(args);\r\n    case 'quran_pedagogy': return quran_pedagogy(args);\r\n    default: return { error: `Unknown tool: ${functionName}` };\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1756, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/general_web_search_flow.ts"],"sourcesContent":["import { defineFlow } from '@genkit-ai/flow';\r\nimport { z } from 'zod';\r\nimport * as cheerio from 'cheerio';\r\nimport { ai, serperSearchTool } from '../genkit';\r\nimport { GUARDIAN_SANITIZE } from '../tools/handlers';\r\n\r\n/* ======================================================\r\n   1. STRICT CONFIGURATION (UPDATED)\r\n====================================================== */\r\n\r\nconst SPECIFIC_TRUSTED_DOMAINS = [\r\n  'khanacademy.org', 'britannica.com', 'nationalgeographic.com',\r\n  'openstax.org', 'nasa.gov', 'who.int', 'cdc.gov', 'unesco.org',\r\n  'oecd.org', 'bbc.co.uk', 'mit.edu', 'harvard.edu', 'stanford.edu',\r\n  'nature.com', 'scientificamerican.com', 'smithsonianmag.com',\r\n  'ncbi.nlm.nih.gov', 'biologymad.com'\r\n];\r\n\r\nconst TRUSTED_TLDS = ['.edu', '.gov', '.ac.uk', '.org'];\r\nconst MAX_SOURCES = 4;\r\nconst MAX_FACTS = 5; // Reduced to focus on core concepts\r\nconst FETCH_TIMEOUT_MS = 8000;\r\n\r\n/* ======================================================\r\n   2. SCHEMAS\r\n====================================================== */\r\n\r\nconst InputSchema = z.object({\r\n  query: z.string(),\r\n  forceWebSearch: z.boolean().default(false),\r\n  gradeHint: z.enum(['Primary', 'LowerSecondary', 'UpperSecondary']).optional(),\r\n});\r\n\r\nconst OutputSchema = z.object({\r\n  reply: z.string(),\r\n  sources: z.array(\r\n    z.object({\r\n      sourceName: z.string(),\r\n      url: z.string(),\r\n    })\r\n  ).optional(),\r\n  mode: z.literal('web_research'),\r\n});\r\n\r\n/* ======================================================\r\n   3. UTILS\r\n====================================================== */\r\n\r\nfunction cleanText(text: string): string {\r\n  return text.replace(/(\\r\\n|\\n|\\r)/gm, ' ').replace(/\\s+/g, ' ').trim();\r\n}\r\n\r\n/* ======================================================\r\n   4. STEP FUNCTIONS\r\n====================================================== */\r\n\r\nasync function shouldUseWeb(query: string, force: boolean): Promise<boolean> {\r\n  console.log(`[üîç DEEP TRACE] Checking Web Intent. Force=${force}, Query=\"${query}\"`);\r\n  if (force) return true;\r\n\r\n  const prompt = `\r\nQuestion: \"${query}\"\r\nDecide if answering this requires REAL-TIME or CURRENT web information.\r\nRespond ONLY with JSON: { \"needsWeb\": true | false }\r\n`;\r\n  const res = await ai.generate({ model: 'openai/gpt-4o-mini', prompt, output: { format: 'json' } });\r\n  const decision = Boolean((res.output as any)?.needsWeb);\r\n  console.log(`[üîç DEEP TRACE] Web Intent Decision: ${decision}`);\r\n  return decision;\r\n}\r\n\r\nasync function generateResearchPlan(query: string): Promise<string[]> {\r\n  console.log(`[üîç DEEP TRACE] Generating Research Plan...`);\r\n  const prompt = `\r\nCreate a neutral research plan for: \"${query}\"\r\nRules: No teaching language. Max 4 search queries. Output plain lines.\r\n`;\r\n  const res = await ai.generate({ model: 'openai/gpt-4o-mini', prompt });\r\n  const plan = cleanText(res.text).split('. ').map(q => q.trim()).filter(Boolean).slice(0, 4);\r\n  console.log(`[üîç DEEP TRACE] Plan Created: ${JSON.stringify(plan)}`);\r\n  return plan;\r\n}\r\n\r\nasync function scrape(url: string): Promise<string> {\r\n  try {\r\n    const controller = new AbortController();\r\n    setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);\r\n\r\n    const res = await fetch(url, {\r\n      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' },\r\n      signal: controller.signal,\r\n    });\r\n\r\n    if (!res.ok) return '';\r\n\r\n    const html = await res.text();\r\n    const $ = cheerio.load(html);\r\n\r\n    // Remove junk & ads\r\n    $('script, style, nav, footer, header, aside, iframe, img, video, noscript, .ad, .advertisement').remove();\r\n    const text = cleanText($('body').text());\r\n\r\n    // üõë ANTI-GARBAGE FILTER: Detect Security Block Pages\r\n    const lower = text.toLowerCase();\r\n    if (\r\n        lower.includes(\"access denied\") || \r\n        lower.includes(\"security check\") || \r\n        lower.includes(\"cloudflare\") || \r\n        lower.includes(\"captcha\") || \r\n        lower.includes(\"verify you are human\")\r\n    ) {\r\n        console.log(`[üîç DEEP TRACE] üóëÔ∏è Rejected Garbage Page: ${url}`);\r\n        return \"\"; // Reject this source immediately\r\n    }\r\n\r\n    return text.slice(0, 6000);\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\nfunction isTrusted(url: string): boolean {\r\n  try {\r\n    const parsed = new URL(url);\r\n    const hostname = parsed.hostname.toLowerCase();\r\n    if (SPECIFIC_TRUSTED_DOMAINS.some(d => hostname.endsWith(d))) return true;\r\n    if (TRUSTED_TLDS.some(tld => hostname.endsWith(tld))) return true;\r\n    return false;\r\n  } catch { return false; }\r\n}\r\n\r\ninterface Fact { claim: string; source: string; url: string; }\r\n\r\nasync function extractFacts(rawText: string, source: string, url: string): Promise<Fact[]> {\r\n  const prompt = `\r\nExtract clear educational facts.\r\nRules: No opinions, No technical warnings, Max 3 facts.\r\nTEXT: ${rawText.slice(0, 2000)}\r\n`;\r\n  const res = await ai.generate({ model: 'openai/gpt-4o-mini', prompt });\r\n  const lines = cleanText(res.text).split('. ').slice(0, 3);\r\n  return lines.map(line => ({ claim: line.trim(), source, url }));\r\n}\r\n\r\n// ‚úÖ UPDATED: STRICT MICRO-TEACHING SYNTHESIS\r\nasync function synthesizeAnswer(query: string, facts: Fact[]): Promise<string> {\r\n  const hasFacts = facts.length > 0;\r\n  console.log(`[üîç DEEP TRACE] Synthesizing Answer. Facts available: ${hasFacts ? facts.length : 'NONE'}`);\r\n\r\n  const prompt = hasFacts \r\n    ? `\r\n    SYSTEM ROLE: WORLD-CLASS PRIVATE TUTOR\r\n    You are introducing a new topic to a student.\r\n\r\n    Student Question: \"${query}\"\r\n    Research Data:\r\n    ${facts.map(f => `- ${f.claim}`).join('\\n')}\r\n\r\n    **STRICT TEACHING RULES:**\r\n    1. **THE 10% RULE:** Teach ONLY the basic definition/concept first. Do NOT explain stages (like Krebs/Glycolysis), types, or complex chemistry yet. Save that for the next turn.\r\n    2. **LENGTH:** Write exactly 3 to 5 clear sentences.\r\n    3. **NO VOMIT:** Do not list facts. Weave them into a simple explanation.\r\n    4. **NO SOURCES:** Never mention \"I searched\", \"NCBI\", \"JavaScript\", or \"Browsers\".\r\n    5. **CHECKING QUESTION:** End with a simple question to verify they understood the definition (e.g., \"Does that general idea make sense?\").\r\n    ` \r\n    : `\r\n    SYSTEM ROLE: WORLD-CLASS PRIVATE TUTOR\r\n    Student Question: \"${query}\"\r\n    \r\n    TASK:\r\n    1. Introduce the concept simply using your internal knowledge.\r\n    2. **THE 10% RULE:** Definition ONLY. No complex sub-steps yet.\r\n    3. **LENGTH:** 3-5 sentences.\r\n    4. End with a simple question to check understanding.\r\n    `;\r\n\r\n  const res = await ai.generate({ model: 'openai/gpt-4o', prompt });\r\n  return GUARDIAN_SANITIZE(cleanText(res.text));\r\n}\r\n\r\n/* ======================================================\r\n   10. FLOW IMPLEMENTATION\r\n====================================================== */\r\n\r\nexport const generalWebResearchFlow = defineFlow(\r\n  {\r\n    name: 'generalWebResearchFlow',\r\n    inputSchema: InputSchema,\r\n    outputSchema: OutputSchema,\r\n  },\r\n  async (input) => {\r\n    console.log(`[üîç DEEP TRACE] Starting General Web Research Flow...`);\r\n\r\n    const useWeb = await shouldUseWeb(input.query, input.forceWebSearch);\r\n    if (!useWeb) {\r\n      return {\r\n        reply: await GUARDIAN_SANITIZE('This topic does not need web research. I can explain it directly.'),\r\n        mode: 'web_research' as const, \r\n      };\r\n    }\r\n\r\n    const plan = await generateResearchPlan(input.query);\r\n    const collectedFacts: Fact[] = [];\r\n    const sources: { sourceName: string; url: string }[] = [];\r\n    const seen = new Set<string>();\r\n\r\n    for (const q of plan) {\r\n      console.log(`[üîç DEEP TRACE] üîé Executing Query: \"${q}\"`);\r\n      try {\r\n        const res = await serperSearchTool({ query: q });\r\n        const results = res.results?.slice(0, 3) || [];\r\n        console.log(`[üîç DEEP TRACE] found ${results.length} raw links.`);\r\n\r\n        for (const r of results) {\r\n          if (seen.has(r.link)) continue;\r\n          \r\n          if (!isTrusted(r.link)) {\r\n             console.log(`[üîç DEEP TRACE] ‚ö†Ô∏è Untrusted Domain skipped: ${r.link}`);\r\n             continue;\r\n          }\r\n\r\n          console.log(`[üîç DEEP TRACE] üï∑Ô∏è Attempting to scrape: ${r.link}`);\r\n          let text = await scrape(r.link);\r\n          \r\n          // Fallback to snippet if scrape is blocked or empty\r\n          if (!text || text.length < 50) {\r\n             console.log(`[üîç DEEP TRACE] ‚ö†Ô∏è Scrape blocked/empty. Falling back to Search Snippet.`);\r\n             text = r.snippet || \"\";\r\n          }\r\n\r\n          if (!text) {\r\n             console.log(`[üîç DEEP TRACE] ‚ùå No data available.`);\r\n             continue;\r\n          }\r\n\r\n          const facts = await extractFacts(text, r.title, r.link);\r\n          console.log(`[üîç DEEP TRACE] üß™ Extracted ${facts.length} facts.`);\r\n          \r\n          collectedFacts.push(...facts);\r\n          sources.push({ sourceName: r.title, url: r.link });\r\n          seen.add(r.link);\r\n\r\n          if (collectedFacts.length >= MAX_FACTS) break;\r\n        }\r\n      } catch (e) {\r\n        console.error(\"[üîç DEEP TRACE] üí• Search Step Exception:\", e);\r\n      }\r\n\r\n      if (sources.length >= MAX_SOURCES) break;\r\n    }\r\n\r\n    console.log(`[üîç DEEP TRACE] üèÅ Research Complete. Total Facts: ${collectedFacts.length}`);\r\n\r\n    const answer = await synthesizeAnswer(input.query, collectedFacts);\r\n\r\n    return {\r\n      reply: answer,\r\n      sources,\r\n      mode: 'web_research' as const,\r\n    };\r\n  }\r\n);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2021, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/research-orchestrator.ts"],"sourcesContent":["import { runFlow } from '@genkit-ai/flow';\r\nimport { ai } from '../genkit'; \r\nimport { setMode } from '../../lib/research/research-state';\r\nimport { detectResearchIntent } from './intent-detector';\r\nimport { generalWebResearchFlow } from './general_web_search_flow';\r\nimport { webSearchFlow } from './web_search_flow';\r\nimport { youtubeSearchFlow } from './youtube-search-flow'; \r\n\r\ninterface OrchestratorInput {\r\n  query: string;\r\n  lastSearchTopic?: string;\r\n  forceWebSearch?: boolean;\r\n  chatHistory?: { role: string; content: string }[];\r\n}\r\n\r\nconst FORBIDDEN_TOPICS = [\r\n  \"sex\", \"dating\", \"romance\", \"violence\", \"kill\", \"suicide\", \"harm\",\r\n  \"drug\", \"alcohol\", \"politics\", \"vote\", \"gambling\", \"betting\",\r\n  \"hack\", \"cybercrime\", \"cheat\", \"porn\", \"nude\", \"terror\", \"boyfriend\", \"girlfriend\",\r\n  \"bhang\", \"weed\", \"smoke\", \"doggy\", \"yacht\", \"yatch\", \r\n  \"music video\", \"lyrics\", \"official video\", \"song\", \"mp3\", \"playlist\"\r\n];\r\n\r\nfunction isSafeQuery(query: string): boolean {\r\n  const lower = query.toLowerCase();\r\n  return !FORBIDDEN_TOPICS.some(topic => lower.includes(topic));\r\n}\r\n\r\n// ‚úÖ UPGRADED: STRICT CONTEXT REWRITER\r\nasync function generateVideoQuery(userQuery: string, topic?: string): Promise<string> {\r\n    // If no topic exists, we must use the user's query, but strip noise\r\n    if (!topic) return userQuery;\r\n    \r\n    // HEURISTIC: If query contains vague reference words, FORCE topic use.\r\n    const lower = userQuery.toLowerCase();\r\n    const vagueWords = [\"better\", \"another\", \"more\", \"different\", \"best\", \"good\", \"suggest\", \"show\", \"video\", \"youtube\", \"this\", \"that\", \"it\", \"same topic\"];\r\n    \r\n    // If the query is dominated by vague words, REVERT TO TOPIC\r\n    const isVague = vagueWords.some(w => lower.includes(w));\r\n    \r\n    if (isVague) {\r\n        // AI Rewriter for nuance (e.g. \"focus on heart\")\r\n        const prompt = `\r\n        Active Topic: \"${topic}\"\r\n        User Request: \"${userQuery}\"\r\n        \r\n        TASK: Create a clean YouTube search query.\r\n        \r\n        RULES:\r\n        1. IGNORE adjectives like \"better\", \"best\", \"good\", \"another\".\r\n        2. REPLACE \"this\", \"that\", \"it\" with \"${topic}\".\r\n        3. IF user adds a specific detail (e.g. \"focus on lungs\"), append it.\r\n        4. IF user just wants \"another video\", output ONLY \"${topic} educational\".\r\n        5. OUTPUT ONLY THE STRING.\r\n        `;\r\n        const res = await ai.generate({ model: 'openai/gpt-4o-mini', prompt });\r\n        return res.text.trim().replace(/\"/g, '');\r\n    }\r\n    \r\n    return userQuery;\r\n}\r\n\r\nexport async function runResearchOrchestrator(input: OrchestratorInput) {\r\n  setMode('research');\r\n  console.log(`[üîç DEEP TRACE] Orchestrator Input: \"${input.query}\" | Context: \"${input.lastSearchTopic}\"`);\r\n\r\n  const history = input.chatHistory || [];\r\n\r\n  // üõ°Ô∏è STEP 1: SAFETY CHECK\r\n  if (!isSafeQuery(input.query)) {\r\n    console.log(`[üîç DEEP TRACE] üõë BLOCKED Forbidden Topic.`);\r\n    return await runFlow(webSearchFlow, {\r\n      query: input.query,\r\n      chatHistory: history,\r\n      lastSearchTopic: input.lastSearchTopic,\r\n      awaitingPracticeQuestion: false,\r\n      awaitingPracticeAnswer: false,\r\n      attempts: 0,\r\n    });\r\n  }\r\n\r\n  // üß† STEP 2: DETECT INTENT\r\n  const intent = await detectResearchIntent(input.query, input.lastSearchTopic);\r\n  console.log(`[üîç DEEP TRACE] Intent: ${intent}`);\r\n\r\n  // üé¨ STEP 3: VIDEO LOOKUP (WITH INTELLIGENT REWRITING)\r\n  if (intent === 'video_lookup') {\r\n    // ‚úÖ FORCE REWRITING. Never pass raw query directly if context exists.\r\n    const effectiveQuery = await generateVideoQuery(input.query, input.lastSearchTopic);\r\n    console.log(`[üîç DEEP TRACE] üîÑ Video Query Rewritten: \"${input.query}\" -> \"${effectiveQuery}\"`);\r\n\r\n    const videos = await runFlow(youtubeSearchFlow, { query: effectiveQuery });\r\n    \r\n    // Filter bad results (Music, Lyrics, etc)\r\n    const filteredVideos = videos.filter(v => {\r\n        const t = v.title.toLowerCase();\r\n        return !t.includes(\"official video\") && \r\n               !t.includes(\"lyrics\") && \r\n               !t.includes(\"music\") && \r\n               !t.includes(\"reaction\") &&\r\n               !t.includes(\"song\");\r\n    });\r\n\r\n    const video = filteredVideos.length > 0 ? filteredVideos[0] : null;\r\n    const safeChannel = (video?.channel || video?.channelTitle || '').replace('Unknown Channel', '');\r\n\r\n    return {\r\n      mode: 'teaching',\r\n      response: video \r\n        ? `I found a relevant video on **${effectiveQuery}**. Watch below!`\r\n        : `I searched for videos on \"${effectiveQuery}\" but couldn't find a perfect educational match right now.`,\r\n      videoData: video ? { id: video.id, title: video.title, channel: safeChannel, thumbnail: video.thumbnailUrl } : undefined\r\n    };\r\n  }\r\n\r\n  // üü¢ STEP 4: CHAT / TEACHING\r\n  if (intent === 'dialogue_continuation' || intent === 'greeting' || intent === 'clarification' || intent === 'definition' || intent === 'concept_explanation') {\r\n    return await runFlow(webSearchFlow, {\r\n      query: input.query,\r\n      chatHistory: history,\r\n      lastSearchTopic: input.lastSearchTopic,\r\n      awaitingPracticeQuestion: false,\r\n      awaitingPracticeAnswer: false,\r\n      attempts: 0,\r\n    });\r\n  }\r\n\r\n  // üîµ STEP 5: DEEP RESEARCH\r\n  if (intent === 'fact_lookup' || intent === 'deep_research' || input.forceWebSearch) {\r\n    return await runFlow(generalWebResearchFlow, {\r\n      query: input.query,\r\n      forceWebSearch: true,\r\n    });\r\n  }\r\n\r\n  // üî¥ STEP 6: FALLBACK\r\n  return await runFlow(webSearchFlow, {\r\n    query: input.query,\r\n    chatHistory: history,\r\n    lastSearchTopic: input.lastSearchTopic,\r\n    awaitingPracticeQuestion: false,\r\n    awaitingPracticeAnswer: false,\r\n    attempts: 0,\r\n  });\r\n}"],"names":[],"mappings":";;;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AASA,MAAM,mBAAmB;IACvB;IAAO;IAAU;IAAW;IAAY;IAAQ;IAAW;IAC3D;IAAQ;IAAW;IAAY;IAAQ;IAAY;IACnD;IAAQ;IAAc;IAAS;IAAQ;IAAQ;IAAU;IAAa;IACtE;IAAS;IAAQ;IAAS;IAAS;IAAS;IAC5C;IAAe;IAAU;IAAkB;IAAQ;IAAO;CAC3D;AAED,SAAS,YAAY,KAAa;IAChC,MAAM,QAAQ,MAAM,WAAW;IAC/B,OAAO,CAAC,iBAAiB,IAAI,CAAC,CAAA,QAAS,MAAM,QAAQ,CAAC;AACxD;AAEA,sCAAsC;AACtC,eAAe,mBAAmB,SAAiB,EAAE,KAAc;IAC/D,oEAAoE;IACpE,IAAI,CAAC,OAAO,OAAO;IAEnB,uEAAuE;IACvE,MAAM,QAAQ,UAAU,WAAW;IACnC,MAAM,aAAa;QAAC;QAAU;QAAW;QAAQ;QAAa;QAAQ;QAAQ;QAAW;QAAQ;QAAS;QAAW;QAAQ;QAAQ;QAAM;KAAa;IAExJ,4DAA4D;IAC5D,MAAM,UAAU,WAAW,IAAI,CAAC,CAAA,IAAK,MAAM,QAAQ,CAAC;IAEpD,IAAI,SAAS;QACT,iDAAiD;QACjD,MAAM,SAAS,CAAC;uBACD,EAAE,MAAM;uBACR,EAAE,UAAU;;;;;;8CAMW,EAAE,MAAM;;4DAEM,EAAE,MAAM;;QAE5D,CAAC;QACD,MAAM,MAAM,MAAM,kHAAA,CAAA,KAAE,CAAC,QAAQ,CAAC;YAAE,OAAO;YAAsB;QAAO;QACpE,OAAO,IAAI,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,MAAM;IACzC;IAEA,OAAO;AACX;AAEO,eAAe,wBAAwB,KAAwB;IACpE,CAAA,GAAA,0IAAA,CAAA,UAAO,AAAD,EAAE;IACR,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,MAAM,KAAK,CAAC,cAAc,EAAE,MAAM,eAAe,CAAC,CAAC,CAAC;IAExG,MAAM,UAAU,MAAM,WAAW,IAAI,EAAE;IAEvC,2BAA2B;IAC3B,IAAI,CAAC,YAAY,MAAM,KAAK,GAAG;QAC7B,QAAQ,GAAG,CAAC,CAAC,2CAA2C,CAAC;QACzD,OAAO,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,oIAAA,CAAA,gBAAa,EAAE;YAClC,OAAO,MAAM,KAAK;YAClB,aAAa;YACb,iBAAiB,MAAM,eAAe;YACtC,0BAA0B;YAC1B,wBAAwB;YACxB,UAAU;QACZ;IACF;IAEA,2BAA2B;IAC3B,MAAM,SAAS,MAAM,CAAA,GAAA,uIAAA,CAAA,uBAAoB,AAAD,EAAE,MAAM,KAAK,EAAE,MAAM,eAAe;IAC5E,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,QAAQ;IAE/C,uDAAuD;IACvD,IAAI,WAAW,gBAAgB;QAC7B,sEAAsE;QACtE,MAAM,iBAAiB,MAAM,mBAAmB,MAAM,KAAK,EAAE,MAAM,eAAe;QAClF,QAAQ,GAAG,CAAC,CAAC,2CAA2C,EAAE,MAAM,KAAK,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC;QAE/F,MAAM,SAAS,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,8IAAA,CAAA,oBAAiB,EAAE;YAAE,OAAO;QAAe;QAExE,0CAA0C;QAC1C,MAAM,iBAAiB,OAAO,MAAM,CAAC,CAAA;YACjC,MAAM,IAAI,EAAE,KAAK,CAAC,WAAW;YAC7B,OAAO,CAAC,EAAE,QAAQ,CAAC,qBACZ,CAAC,EAAE,QAAQ,CAAC,aACZ,CAAC,EAAE,QAAQ,CAAC,YACZ,CAAC,EAAE,QAAQ,CAAC,eACZ,CAAC,EAAE,QAAQ,CAAC;QACvB;QAEA,MAAM,QAAQ,eAAe,MAAM,GAAG,IAAI,cAAc,CAAC,EAAE,GAAG;QAC9D,MAAM,cAAc,CAAC,OAAO,WAAW,OAAO,gBAAgB,EAAE,EAAE,OAAO,CAAC,mBAAmB;QAE7F,OAAO;YACL,MAAM;YACN,UAAU,QACN,CAAC,8BAA8B,EAAE,eAAe,gBAAgB,CAAC,GACjE,CAAC,0BAA0B,EAAE,eAAe,0DAA0D,CAAC;YAC3G,WAAW,QAAQ;gBAAE,IAAI,MAAM,EAAE;gBAAE,OAAO,MAAM,KAAK;gBAAE,SAAS;gBAAa,WAAW,MAAM,YAAY;YAAC,IAAI;QACjH;IACF;IAEA,6BAA6B;IAC7B,IAAI,WAAW,2BAA2B,WAAW,cAAc,WAAW,mBAAmB,WAAW,gBAAgB,WAAW,uBAAuB;QAC5J,OAAO,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,oIAAA,CAAA,gBAAa,EAAE;YAClC,OAAO,MAAM,KAAK;YAClB,aAAa;YACb,iBAAiB,MAAM,eAAe;YACtC,0BAA0B;YAC1B,wBAAwB;YACxB,UAAU;QACZ;IACF;IAEA,2BAA2B;IAC3B,IAAI,WAAW,iBAAiB,WAAW,mBAAmB,MAAM,cAAc,EAAE;QAClF,OAAO,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,4IAAA,CAAA,yBAAsB,EAAE;YAC3C,OAAO,MAAM,KAAK;YAClB,gBAAgB;QAClB;IACF;IAEA,sBAAsB;IACtB,OAAO,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,oIAAA,CAAA,gBAAa,EAAE;QAClC,OAAO,MAAM,KAAK;QAClB,aAAa;QACb,iBAAiB,MAAM,eAAe;QACtC,0BAA0B;QAC1B,wBAAwB;QACxB,UAAU;IACZ;AACF","debugId":null}},
    {"offset": {"line": 2204, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/title-generator.ts"],"sourcesContent":["import OpenAI from 'openai';\r\nimport { Message } from '../../lib/types'; \r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function generateChatTitle(history: Message[], currentMessage: string): Promise<string | null> {\r\n  // 1. CONTEXT ASSEMBLY\r\n  // Get the last 3 turns to understand the \"Flow\"\r\n  // This allows us to title \"Yes\" correctly based on the previous question.\r\n  const relevantHistory = history.slice(-3);\r\n  const conversationSnippet = [\r\n    ...relevantHistory,\r\n    { role: 'user', content: currentMessage }\r\n  ].map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\\n');\r\n\r\n  const systemPrompt = `\r\n  TASK: Generate a lively, relevant, and short title (2-5 words) for this chat session.\r\n\r\n  CONTEXT AWARENESS:\r\n  - If the user says \"Yes\" or \"Okay\", look at the previous message to see WHAT they agreed to. (e.g. \"Math Lesson Start\").\r\n  - If it is a greeting, make it friendly (e.g. \"Warm Welcome\").\r\n  - If it is a question, capture the core topic (e.g. \"Photosynthesis Query\").\r\n  \r\n  RULES:\r\n  1. NO quotes.\r\n  2. NO \"New Chat\", \"Untitled\", or \"General Discussion\".\r\n  3. Be specific but concise.\r\n  4. Capitalize First Letters.\r\n\r\n  EXAMPLES:\r\n  - User: \"I want to learn Algebra\" -> Title: Algebra Practice\r\n  - User: \"Hi\" -> Title: Friendly Greeting\r\n  - AI: \"Ready for math?\" User: \"Yes\" -> Title: Math Lesson Setup\r\n  - User: \"Who is the president?\" -> Title: Kenya Civics Inquiry\r\n  `;\r\n\r\n  try {\r\n    const completion = await openai.chat.completions.create({\r\n      model: 'gpt-3.5-turbo',\r\n      messages: [\r\n        { role: 'system', content: systemPrompt },\r\n        { role: 'user', content: `CONVERSATION LOG:\\n${conversationSnippet}` }\r\n      ],\r\n      temperature: 0.7, // Higher temp = More creative/human titles\r\n      max_tokens: 15,\r\n    });\r\n    \r\n    let title = completion.choices[0].message.content?.trim().replace(/[\"']/g, '') || \"\";\r\n\r\n    // 2. FINAL SAFETY NET (Smart Fallback)\r\n    // If the AI fails or returns forbidden generic words, we construct a title manually\r\n    const lowerTitle = title.toLowerCase();\r\n    const forbidden = [\"new chat\", \"untitled\", \"general discussion\", \"conversation\"];\r\n    \r\n    if (!title || title.length < 3 || forbidden.some(w => lowerTitle.includes(w))) {\r\n        // Fallback: Use the first meaningful words of the user's input\r\n        // e.g. \"I want to learn about atoms\" -> \"Learn About Atoms\"\r\n        const words = currentMessage.split(' ').filter(w => w.length > 2);\r\n        if (words.length > 0) {\r\n             title = words.slice(0, 4).join(' ');\r\n             title = title.charAt(0).toUpperCase() + title.slice(1);\r\n        } else {\r\n             title = \"Chat Session\";\r\n        }\r\n    }\r\n\r\n    return title;\r\n\r\n  } catch (error) {\r\n    console.error(`[TITLE GEN] Error:`, error);\r\n    // Even on error, try to extract a title from input instead of \"Error\"\r\n    const fallback = currentMessage.substring(0, 20) + (currentMessage.length > 20 ? \"...\" : \"\");\r\n    return fallback || \"Chat Session\";\r\n  }\r\n}"],"names":[],"mappings":";;;AAAA;AAAA;;AAGA,MAAM,SAAS,IAAI,sKAAA,CAAA,UAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEO,eAAe,kBAAkB,OAAkB,EAAE,cAAsB;IAChF,sBAAsB;IACtB,gDAAgD;IAChD,0EAA0E;IAC1E,MAAM,kBAAkB,QAAQ,KAAK,CAAC,CAAC;IACvC,MAAM,sBAAsB;WACvB;QACH;YAAE,MAAM;YAAQ,SAAS;QAAe;KACzC,CAAC,GAAG,CAAC,CAAA,IAAK,GAAG,EAAE,IAAI,CAAC,WAAW,GAAG,EAAE,EAAE,EAAE,OAAO,EAAE,EAAE,IAAI,CAAC;IAEzD,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;;;EAmBtB,CAAC;IAED,IAAI;QACF,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAa;gBACxC;oBAAE,MAAM;oBAAQ,SAAS,CAAC,mBAAmB,EAAE,qBAAqB;gBAAC;aACtE;YACD,aAAa;YACb,YAAY;QACd;QAEA,IAAI,QAAQ,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,OAAO,QAAQ,SAAS,OAAO;QAElF,uCAAuC;QACvC,oFAAoF;QACpF,MAAM,aAAa,MAAM,WAAW;QACpC,MAAM,YAAY;YAAC;YAAY;YAAY;YAAsB;SAAe;QAEhF,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,KAAK,UAAU,IAAI,CAAC,CAAA,IAAK,WAAW,QAAQ,CAAC,KAAK;YAC3E,+DAA+D;YAC/D,4DAA4D;YAC5D,MAAM,QAAQ,eAAe,KAAK,CAAC,KAAK,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,GAAG;YAC/D,IAAI,MAAM,MAAM,GAAG,GAAG;gBACjB,QAAQ,MAAM,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC;gBAC/B,QAAQ,MAAM,MAAM,CAAC,GAAG,WAAW,KAAK,MAAM,KAAK,CAAC;YACzD,OAAO;gBACF,QAAQ;YACb;QACJ;QAEA,OAAO;IAET,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,kBAAkB,CAAC,EAAE;QACpC,sEAAsE;QACtE,MAAM,WAAW,eAAe,SAAS,CAAC,GAAG,MAAM,CAAC,eAAe,MAAM,GAAG,KAAK,QAAQ,EAAE;QAC3F,OAAO,YAAY;IACrB;AACF","debugId":null}},
    {"offset": {"line": 2296, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/tools/scope-guardian.ts"],"sourcesContent":["/**\r\n * scope-guardian.ts\r\n * \r\n * DYNAMIC SCOPE ENFORCEMENT\r\n * Blocks non-educational content with context-aware, natural redirection.\r\n */\r\n\r\ntype ViolationCategory = 'sexual' | 'violence' | 'drugs' | 'gossip' | 'harsh_slang' | 'unknown';\r\n\r\nconst CATEGORY_MAP: Record<ViolationCategory, string[]> = {\r\n  sexual: [\r\n    \"sex\", \"sexual\", \"sodomy\", \"gay\", \"lesbian\", \"homosexual\", \"bisexual\", \"transgender\",\r\n    \"dating\", \"romance\", \"boyfriend\", \"girlfriend\", \"kissing\", \"making out\",\r\n    \"virgin\", \"condom\", \"intercourse\", \"masturbate\", \"porn\", \"onlyfans\", \"nude\"\r\n  ],\r\n  violence: [\r\n    \"kill yourself\", \"suicide\", \"murder\", \"how to kill\", \"bomb\", \"terrorist\",\r\n    \"cut myself\", \"self-harm\", \"gun\", \"weapon\", \"shoot\", \"fight\", \"blood\"\r\n  ],\r\n  drugs: [\r\n    \"cocaine\", \"heroin\", \"meth\", \"weed\", \"marijuana\", \"bhang\", \"cannabis\",\r\n    \"drunk\", \"alcohol\", \"beer\", \"wine\", \"vodka\", \"get high\", \"smoke\"\r\n  ],\r\n  gossip: [\r\n    \"diddy\", \"kanye\", \"drake\", \"celebrity\", \"gossip\", \"who is dating\",\r\n    \"rap music\", \"music video\", \"concert\", \"famous people\", \"drama\"\r\n  ],\r\n  harsh_slang: [\r\n    \"gyat\", \"rizz\", \"skibidi\", \"sigma\", \"fanum tax\" // Optional: Gen Alpha slang filter\r\n  ],\r\n  unknown: []\r\n};\r\n\r\n/**\r\n * Detects if input is out of scope and returns the category.\r\n * Returns NULL if safe.\r\n */\r\nexport function detectScopeViolation(input: string): ViolationCategory | null {\r\n  if (!input) return null;\r\n  const normalized = input.toLowerCase();\r\n\r\n  for (const [category, keywords] of Object.entries(CATEGORY_MAP)) {\r\n    for (const keyword of keywords) {\r\n      // Precise matching for short words\r\n      if (keyword.length <= 4) {\r\n         if (new RegExp(`\\\\b${keyword}\\\\b`, 'i').test(normalized)) return category as ViolationCategory;\r\n      } else {\r\n         if (normalized.includes(keyword)) return category as ViolationCategory;\r\n      }\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Checks if out of scope (Boolean wrapper for simple checks)\r\n */\r\nexport function isOutOfScope(input: string): boolean {\r\n  return detectScopeViolation(input) !== null;\r\n}\r\n\r\n/**\r\n * Generates a Context-Aware, Natural Redirection.\r\n * No apologies. No lectures. Just a firm, gentle pivot.\r\n */\r\nexport function getDynamicScopeResponse(input: string): string {\r\n  const category = detectScopeViolation(input);\r\n\r\n  const pivots = [\r\n    \"Let us focus on your studies instead.\",\r\n    \"I want to help you with your schoolwork.\",\r\n    \"That is not something we learn in this class.\",\r\n    \"Let's get back to the lesson.\",\r\n    \"We are here to build your knowledge.\"\r\n  ];\r\n  \r\n  const randomPivot = pivots[Math.floor(Math.random() * pivots.length)];\r\n\r\n  switch (category) {\r\n    case 'sexual':\r\n      return `That is a personal topic, not for school. ${randomPivot} Do you have a question about Science or Biology?`;\r\n    \r\n    case 'violence':\r\n      return `We do not discuss harmful things here. We focus on building a good future. ${randomPivot}`;\r\n    \r\n    case 'drugs':\r\n      return `That is harmful to the body and mind. As your teacher, I want you to stay healthy. ${randomPivot} Shall we try a math problem instead?`;\r\n    \r\n    case 'gossip':\r\n      return `Celebrities and music are for free time, not study time. ${randomPivot} What subject are you working on?`;\r\n      \r\n    case 'harsh_slang':\r\n      return `Let us use clear, proper English for learning. ${randomPivot}`;\r\n\r\n    default:\r\n      // Fallback for generic catches\r\n      return `That topic is outside our learning scope. ${randomPivot} You can ask me about Maths, Science, English, or Religion.`;\r\n  }\r\n}"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;AAID,MAAM,eAAoD;IACxD,QAAQ;QACN;QAAO;QAAU;QAAU;QAAO;QAAW;QAAc;QAAY;QACvE;QAAU;QAAW;QAAa;QAAc;QAAW;QAC3D;QAAU;QAAU;QAAe;QAAc;QAAQ;QAAY;KACtE;IACD,UAAU;QACR;QAAiB;QAAW;QAAU;QAAe;QAAQ;QAC7D;QAAc;QAAa;QAAO;QAAU;QAAS;QAAS;KAC/D;IACD,OAAO;QACL;QAAW;QAAU;QAAQ;QAAQ;QAAa;QAAS;QAC3D;QAAS;QAAW;QAAQ;QAAQ;QAAS;QAAY;KAC1D;IACD,QAAQ;QACN;QAAS;QAAS;QAAS;QAAa;QAAU;QAClD;QAAa;QAAe;QAAW;QAAiB;KACzD;IACD,aAAa;QACX;QAAQ;QAAQ;QAAW;QAAS,YAAY,mCAAmC;KACpF;IACD,SAAS,EAAE;AACb;AAMO,SAAS,qBAAqB,KAAa;IAChD,IAAI,CAAC,OAAO,OAAO;IACnB,MAAM,aAAa,MAAM,WAAW;IAEpC,KAAK,MAAM,CAAC,UAAU,SAAS,IAAI,OAAO,OAAO,CAAC,cAAe;QAC/D,KAAK,MAAM,WAAW,SAAU;YAC9B,mCAAmC;YACnC,IAAI,QAAQ,MAAM,IAAI,GAAG;gBACtB,IAAI,IAAI,OAAO,CAAC,GAAG,EAAE,QAAQ,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,aAAa,OAAO;YACpE,OAAO;gBACJ,IAAI,WAAW,QAAQ,CAAC,UAAU,OAAO;YAC5C;QACF;IACF;IACA,OAAO;AACT;AAKO,SAAS,aAAa,KAAa;IACxC,OAAO,qBAAqB,WAAW;AACzC;AAMO,SAAS,wBAAwB,KAAa;IACnD,MAAM,WAAW,qBAAqB;IAEtC,MAAM,SAAS;QACb;QACA;QACA;QACA;QACA;KACD;IAED,MAAM,cAAc,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,OAAO,MAAM,EAAE;IAErE,OAAQ;QACN,KAAK;YACH,OAAO,CAAC,0CAA0C,EAAE,YAAY,iDAAiD,CAAC;QAEpH,KAAK;YACH,OAAO,CAAC,2EAA2E,EAAE,aAAa;QAEpG,KAAK;YACH,OAAO,CAAC,mFAAmF,EAAE,YAAY,qCAAqC,CAAC;QAEjJ,KAAK;YACH,OAAO,CAAC,yDAAyD,EAAE,YAAY,iCAAiC,CAAC;QAEnH,KAAK;YACH,OAAO,CAAC,+CAA+C,EAAE,aAAa;QAExE;YACE,+BAA+B;YAC/B,OAAO,CAAC,0CAA0C,EAAE,YAAY,2DAA2D,CAAC;IAChI;AACF","debugId":null}},
    {"offset": {"line": 2433, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/tools/multilingual-governance.ts"],"sourcesContent":["/**\r\n * src/tools/multilingual-governance.ts\r\n * \r\n * THE LANGUAGE SOUL OF STEADFAST AI\r\n * Defines the Persona, Cultural Nuance, and Pedagogical Rules for each language.\r\n * optimized for 1,000+ concurrent users (Concise, High-Impact Instructions).\r\n */\r\n\r\nexport type SupportedLanguage = 'english' | 'swahili' | 'arabic' | 'english_sw';\r\n\r\ninterface LanguageProfile {\r\n  identity: string;\r\n  tone: string;\r\n  culturalContext: string; \r\n  rules: string[];\r\n  formatting: string[];\r\n  failureStrategy: string; \r\n}\r\n\r\nconst ENGLISH_PROFILE: LanguageProfile = {\r\n  identity: \"You are STEADFAST, a warm, intelligent, patient Cambridge Curriculum teacher. You teach children.\",\r\n  tone: \"Kind, firm, parent-like warmth. Never robotic.\",\r\n  culturalContext: \"Use examples from daily Kenyan life (markets, farming, sports). Speak like a caring mentor.\",\r\n  rules: [\r\n    \"ONE STEP RULE: Explain ONLY ONE step at a time. Then ask a checking question. Wait for response.\",\r\n    \"NO DUMPING: Never explain the whole topic at once. Never give the final answer immediately.\",\r\n    \"SOCRATIC METHOD: Teach WITH the student. End every turn with a question or a choice.\",\r\n    \"EXAMPLE BUDGET: Max ONE example per message. Only if concept is abstract. No confusing metaphors.\",\r\n    \"NO DOUBLE EXAMPLES: Never give two examples (e.g. football AND mangoes). Choose one.\",\r\n    // ‚úÖ CHANGED: Context-aware stepping\r\n    \"CONDITIONAL STEPS: Use 'Step one' ONLY when guiding a multi-step math problem or procedure. Do NOT use it for definitions or chat.\",\r\n  ],\r\n  formatting: [\r\n    \"Natural paragraphs. No 'Micro-Idea:' labels.\",\r\n    \"Short sentences (Under 60 words for readability).\",\r\n    \"Plain text math (1/2). NO LaTeX commands.\",\r\n    \"Parentheses: Only numbers inside (1/2). No words inside ((like this)).\",\r\n  ],\r\n  failureStrategy: \"If a tool/video fails, do NOT announce the failure. Seamlessly pivot to explaining the concept yourself with confidence.\"\r\n};\r\n\r\nconst ARABIC_PROFILE: LanguageProfile = {\r\n  identity: \"ÿ£ŸÜÿ™ 'ÿßŸÑŸÖÿπŸÑŸÖ ÿ≥ÿ™ŸäÿØŸÅÿßÿ≥ÿ™'ÿå ŸÖÿπŸÑŸÖ ŸÖŸÜŸáÿ¨ ŸÉÿßŸÖÿ®ÿ±ŸäÿØÿ¨ÿå ÿ≠ŸÉŸäŸÖ Ÿàÿµÿ®Ÿàÿ±. ÿ™ÿπŸÑŸÖ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ.\",\r\n  tone: \"ŸàŸÇŸàÿ±ÿå ŸÖÿ¥ÿ¨ÿπÿå ÿ£ÿ®ŸàŸäÿå ŸÖŸÑŸäÿ° ÿ®ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÖ ŸàÿßŸÑÿ≥ŸÉŸäŸÜÿ©.\",\r\n  culturalContext: \"ÿ£ŸÜÿ™ ŸÖÿπŸÑŸÖ ÿ™ŸÇŸÑŸäÿØŸä ŸÖÿ≠ÿ™ÿ±ŸÖ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿπÿ®ÿßÿ±ÿßÿ™ ŸÖÿ´ŸÑ 'Ÿäÿß ÿ®ŸÜŸä'ÿå 'ÿ®ÿßÿ±ŸÉ ÿßŸÑŸÑŸá ŸÅŸäŸÉ'. ÿßŸÅŸáŸÖ ÿßŸÑŸÑŸáÿ¨ÿßÿ™ ÿßŸÑÿπÿßŸÖŸäÿ© ŸàŸÑŸÉŸÜ ÿ£ÿ¨ÿ® ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÅÿµÿ≠Ÿâ ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©.\",\r\n  rules: [\r\n    \"ŸÇÿßÿπÿØÿ© ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©: ÿßÿ¥ÿ±ÿ≠ ÿÆÿ∑Ÿàÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ŸÅŸä ŸÉŸÑ ŸÖÿ±ÿ©. ÿ´ŸÖ ÿßÿ∑ÿ±ÿ≠ ÿ≥ÿ§ÿßŸÑÿßŸã.\",\r\n    \"ŸÑÿß ŸÑŸÑÿ≥ÿ±ÿØ ÿßŸÑÿ∑ŸàŸäŸÑ: ŸÑÿß ÿ™ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ŸÉÿßŸÖŸÑÿßŸã ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©. ŸÑÿß ÿ™ÿπÿ∑Ÿê ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© ŸÅŸàÿ±ÿßŸã.\",\r\n    \"ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≥ŸÇÿ±ÿßÿ∑Ÿäÿ©: ÿπŸÑŸëŸÖ ÿßŸÑÿ∑ÿßŸÑÿ® ÿ®ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©. ÿßÿÆÿ™ŸÖ ŸÉŸÑ ÿ±ÿØ ÿ®ÿ≥ÿ§ÿßŸÑ.\",\r\n    \"ŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿ£ŸÖÿ´ŸÑÿ©: ŸÖÿ´ÿßŸÑ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ. ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßÿ≥ÿ™ÿπÿßÿ±ÿßÿ™ ŸÖÿπŸÇÿØÿ©.\",\r\n    \"ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ: ÿπŸÜÿØ ÿ∞ŸÉÿ± ÿ¢Ÿäÿ©ÿå ÿßÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿπŸÜŸâ ÿßŸÑÿπÿßŸÖ ŸàÿßŸÑÿ£ÿÆŸÑÿßŸÇŸä ŸÅŸÇÿ∑.\",\r\n    // ‚úÖ CHANGED: Context-aware stepping\r\n    \"ÿÆÿ∑Ÿàÿßÿ™ ŸÖÿ¥ÿ±Ÿàÿ∑ÿ©: ÿßÿ≥ÿ™ÿÆÿØŸÖ 'ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ£ŸàŸÑŸâ' ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑÿÆÿ∑Ÿàÿßÿ™.\",\r\n  ],\r\n  formatting: [\r\n    \"ÿßÿ™ÿ®ÿπ ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸäŸÖŸäŸÜ ŸÑŸÑŸäÿ≥ÿßÿ± (RTL) ÿ®ÿµÿ±ÿßŸÖÿ©.\",\r\n    \"ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ: ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (1ÿå 2ÿå 3).\",\r\n    \"ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ŸÇŸäŸÖ: ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© (ÿü ÿå ÿõ).\",\r\n    \"ŸÑÿß ÿ™ÿÆŸÑÿ∑ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ•ŸÑÿß ŸÑŸÑÿ∂ÿ±Ÿàÿ±ÿ© ÿßŸÑŸÇÿµŸàŸâ.\",\r\n  ],\r\n  failureStrategy: \"ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ¨ÿØ ŸÅŸäÿØŸäŸà ÿ£Ÿà ŸÖÿπŸÑŸàŸÖÿ©ÿå ŸÑÿß ÿ™ÿπÿ™ÿ∞ÿ±. ÿßÿ®ÿØÿ£ ŸÅŸàÿ±ÿßŸã ÿ®ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿ®ÿ£ÿ≥ŸÑŸàÿ®ŸÉ ÿßŸÑÿÆÿßÿµ ŸàŸÉÿ£ŸÜŸÉ ÿßŸÑŸÖÿ±ÿ¨ÿπ.\"\r\n};\r\n\r\nconst SWAHILI_PROFILE: LanguageProfile = {\r\n  identity: \"Wewe ni MWALIMU STEADFAST. Mwalimu wa Cambridge, mwerevu, mpole. Unafunza watoto.\",\r\n  tone: \"Kirafiki, Heshima, Mchangamfu. Kama baba au mjomba.\",\r\n  culturalContext: \"Tumia Kiswahili sanifu cha shuleni. Epuka Kiswahili cha vitabu vya zamani sana.\",\r\n  rules: [\r\n    \"HATUA MOJA: Fafanua hatua moja tu kwa wakati. Kisha uliza swali.\",\r\n    \"USIMWAGE MAELEZO: Usifafanue somo zima mara moja. Usitoe jibu la mwisho haraka.\",\r\n    \"NJIA YA SOCRATES: Fundisha pamoja na mwanafunzi. Maliza kila jibu na swali.\",\r\n    \"MFANO MMOJA: Toa mfano mmoja tu. Usichanganye mifano miwili.\",\r\n    // ‚úÖ CHANGED: Context-aware stepping\r\n    \"HATUA: Tumia 'Hatua ya kwanza' tu wakati wa kutatua hesabu. Usitumie kwa maelezo ya kawaida.\",\r\n  ],\r\n  formatting: [\r\n    \"Maelezo mafupi na ya moja kwa moja.\",\r\n    \"Tumia nambari za kawaida (1, 2, 3).\",\r\n  ],\r\n  failureStrategy: \"Kama huna video au jibu la mtandao, usiseme 'samahani'. Anza kufafanua somo hilo kwa maneno yako mwenyewe.\"\r\n};\r\n\r\nconst SHENG_PROFILE: LanguageProfile = {\r\n  identity: \"We ni Mwalimu Mtaani. Cambridge teacher but cool. Unafunza vijana.\",\r\n  tone: \"Casual, Cool, Relatable but Respectful. 'Big Brother' vibes.\",\r\n  culturalContext: \"Nairobi style. Tumia lugha ya vijana (Sheng) kuelezea vitu vigumu viwe rahisi.\",\r\n  rules: [\r\n    \"ONE STEP: Explain kitu moja, alafu uliza swali.\",\r\n    \"NO DUMPING: Usilete lectures ndefu. Keep it short.\",\r\n    \"SOCRATIC: Engage student. Usiwape jibu straight.\",\r\n    \"ONE EXAMPLE: Mfano moja inatosha.\",\r\n  ],\r\n  formatting: [\r\n    \"Sentensi fupi fupi. Kama text message.\",\r\n    \"No complex grammar.\",\r\n  ],\r\n  failureStrategy: \"Kama tool imefail, usi-panic. Piga stori na uelezee hio concept mwenyewe.\"\r\n};\r\n\r\nexport function getLanguageGovernance(lang: string, interests: string[]): string {\r\n  const normalizedLang = (lang || 'english').toLowerCase();\r\n  \r\n  let profile = ENGLISH_PROFILE; // Default Fallback\r\n  if (normalizedLang.includes('arab')) profile = ARABIC_PROFILE;\r\n  else if (normalizedLang === 'swahili') profile = SWAHILI_PROFILE;\r\n  else if (normalizedLang.includes('mix') || normalizedLang.includes('sheng')) profile = SHENG_PROFILE;\r\n\r\n  // Personalization Block (Optimized for Tokens)\r\n  const interestsBlock = interests.length > 0\r\n    ? `\\n**PERSONALIZATION (MANDATORY)**\\nStudent loves: ${interests.join(', ')}.\\nINSTRUCTION: You MUST use these interests to explain concepts. Do NOT use generic examples.`\r\n    : `\\n**DEFAULT CONTEXT**\\nUse general relatable Kenyan examples (Mandazi, Farming, Matatu).`;\r\n\r\n  // Final Prompt Construction\r\n  return `\r\n**SYSTEM IDENTITY**\r\n${profile.identity}\r\n\r\n**TONE & CULTURE**\r\n${profile.tone}\r\n${profile.culturalContext}\r\n${interestsBlock}\r\n\r\n**GOVERNANCE RULES (NON-NEGOTIABLE)**\r\n${profile.rules.map(r => `- ${r}`).join('\\n')}\r\n\r\n**FORMATTING LAWS**\r\n${profile.formatting.map(f => `- ${f}`).join('\\n')}\r\n\r\n**ERROR HANDLING STRATEGY**\r\n${profile.failureStrategy}\r\n`;\r\n}"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;AAaD,MAAM,kBAAmC;IACvC,UAAU;IACV,MAAM;IACN,iBAAiB;IACjB,OAAO;QACL;QACA;QACA;QACA;QACA;QACA,oCAAoC;QACpC;KACD;IACD,YAAY;QACV;QACA;QACA;QACA;KACD;IACD,iBAAiB;AACnB;AAEA,MAAM,iBAAkC;IACtC,UAAU;IACV,MAAM;IACN,iBAAiB;IACjB,OAAO;QACL;QACA;QACA;QACA;QACA;QACA,oCAAoC;QACpC;KACD;IACD,YAAY;QACV;QACA;QACA;QACA;KACD;IACD,iBAAiB;AACnB;AAEA,MAAM,kBAAmC;IACvC,UAAU;IACV,MAAM;IACN,iBAAiB;IACjB,OAAO;QACL;QACA;QACA;QACA;QACA,oCAAoC;QACpC;KACD;IACD,YAAY;QACV;QACA;KACD;IACD,iBAAiB;AACnB;AAEA,MAAM,gBAAiC;IACrC,UAAU;IACV,MAAM;IACN,iBAAiB;IACjB,OAAO;QACL;QACA;QACA;QACA;KACD;IACD,YAAY;QACV;QACA;KACD;IACD,iBAAiB;AACnB;AAEO,SAAS,sBAAsB,IAAY,EAAE,SAAmB;IACrE,MAAM,iBAAiB,CAAC,QAAQ,SAAS,EAAE,WAAW;IAEtD,IAAI,UAAU,iBAAiB,mBAAmB;IAClD,IAAI,eAAe,QAAQ,CAAC,SAAS,UAAU;SAC1C,IAAI,mBAAmB,WAAW,UAAU;SAC5C,IAAI,eAAe,QAAQ,CAAC,UAAU,eAAe,QAAQ,CAAC,UAAU,UAAU;IAEvF,+CAA+C;IAC/C,MAAM,iBAAiB,UAAU,MAAM,GAAG,IACtC,CAAC,kDAAkD,EAAE,UAAU,IAAI,CAAC,MAAM,8FAA8F,CAAC,GACzK,CAAC,wFAAwF,CAAC;IAE9F,4BAA4B;IAC5B,OAAO,CAAC;;AAEV,EAAE,QAAQ,QAAQ,CAAC;;;AAGnB,EAAE,QAAQ,IAAI,CAAC;AACf,EAAE,QAAQ,eAAe,CAAC;AAC1B,EAAE,eAAe;;;AAGjB,EAAE,QAAQ,KAAK,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,MAAM;;;AAG9C,EAAE,QAAQ,UAAU,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,MAAM;;;AAGnD,EAAE,QAAQ,eAAe,CAAC;AAC1B,CAAC;AACD","debugId":null}},
    {"offset": {"line": 2552, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/emotional-ai-copilot.ts"],"sourcesContent":["'use server';\r\n\r\nimport OpenAI from 'openai';\r\nimport { ChatCompletionMessageParam } from 'openai/resources/chat/completions';\r\nimport { runFlow } from '@genkit-ai/flow';\r\nimport { webSearchFlow } from './web_search_flow';\r\nimport { getYoutubeTranscriptFlow } from './get-youtube-transcript';\r\nimport { youtubeSearchFlow } from './youtube-search-flow'; \r\nimport { runResearchOrchestrator } from './research-orchestrator';\r\nimport { GUARDIAN_SANITIZE } from '../tools/handlers';\r\nimport { generateChatTitle } from './title-generator';\r\n\r\n// ‚úÖ Import Scope Guardian\r\nimport { isOutOfScope, getDynamicScopeResponse } from '../tools/scope-guardian';\r\n\r\n// ‚úÖ NEW: Import Multilingual Governance\r\nimport { getLanguageGovernance } from '../tools/multilingual-governance';\r\n\r\n// ‚úÖ Relative Import\r\nimport { ConversationState, Message } from '../../lib/types'; \r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\ninterface ExtendedConversationState extends ConversationState {\r\n  activePracticeQuestion?: string;\r\n  correctAnswers?: string[];\r\n  lastTopic?: string;\r\n  lastAssistantMessage?: string;\r\n  conversationState?: 'initial_search' | 'awaiting_practice_response' | 'providing_practice_question' | 'general';\r\n}\r\n\r\nexport interface EmotionalAICopilotInput {\r\n  text: string;\r\n  chatHistory: Message[];\r\n  state: ConversationState;\r\n  studentProfile: {\r\n    name: string;\r\n    gradeLevel: string;\r\n  };\r\n  preferences: {\r\n    preferredLanguage?: 'english' | 'swahili' | 'arabic' | 'english_sw';\r\n    interests?: string[]; \r\n  };\r\n  fileData?: { type: string; base64: string };\r\n  forceWebSearch?: boolean;\r\n  includeVideos?: boolean;\r\n  currentTitle?: string;\r\n  memory?: {\r\n    progress?: any[];\r\n    mistakes?: any[];\r\n  };\r\n}\r\n\r\nexport interface EmotionalAICopilotOutput {\r\n  processedText: string;\r\n  videoData?: { id: string; title: string; channel?: string; thumbnail?: string };\r\n  state: ConversationState;\r\n  topic?: string;\r\n  sources?: { sourceName: string; url: string }[];\r\n  suggestedTitle?: string;\r\n}\r\n\r\nfunction validateAnswer(studentInput: string, correctAnswers: string[]): boolean {\r\n    const userAnswer = studentInput.trim().toLowerCase();\r\n    if (userAnswer.length === 0) return false;\r\n    return correctAnswers.some(ans => userAnswer.includes(ans.toLowerCase()));\r\n}\r\n\r\nexport async function emotionalAICopilot(input: EmotionalAICopilotInput): Promise<EmotionalAICopilotOutput> {\r\n  const rawInterests = input.preferences?.interests || [];\r\n  console.log(`[üîç TRACE] Student: ${input.studentProfile.name} | Interests: ${rawInterests.join(', ')}`);\r\n  \r\n  // ==============================================================================\r\n  // üîí SCOPE GUARDIAN (SAFETY LOCK)\r\n  // ==============================================================================\r\n  if (isOutOfScope(input.text)) {\r\n      console.log(`[üõ°Ô∏è SCOPE GUARDIAN] Blocked input: \"${input.text}\"`);\r\n      \r\n      return {\r\n          processedText: getDynamicScopeResponse(input.text),\r\n          state: input.state,\r\n          topic: input.state.lastSearchTopic?.[0] || \"General\", \r\n          suggestedTitle: input.currentTitle,\r\n          videoData: undefined,\r\n          sources: []\r\n      };\r\n  }\r\n\r\n  // --- Normal Flow Continues Below ---\r\n\r\n  let updatedState: ExtendedConversationState = JSON.parse(JSON.stringify(input.state));\r\n  if (updatedState.validationAttemptCount === undefined) updatedState.validationAttemptCount = 0;\r\n  if (updatedState.awaitingPracticeQuestionAnswer === undefined) updatedState.awaitingPracticeQuestionAnswer = false;\r\n\r\n  let responseText: string = '';\r\n  let videoData: EmotionalAICopilotOutput['videoData'] | undefined = undefined;\r\n  let suggestedTitle: string | undefined = undefined;\r\n\r\n  // ==============================================================================\r\n  // 1. TITLE GENERATION (SMART UPDATE)\r\n  // ==============================================================================\r\n  const isGenericTitle = !input.currentTitle || \r\n                         input.currentTitle === 'New Chat' || \r\n                         input.currentTitle === 'Untitled';\r\n  \r\n  if (isGenericTitle && input.text.length > 1) {\r\n      const newTitle = await generateChatTitle(input.chatHistory, input.text);\r\n      if (newTitle && newTitle !== \"New Chat\" && newTitle !== \"General Discussion\") {\r\n          suggestedTitle = newTitle;\r\n      }\r\n  }\r\n\r\n  // ==============================================================================\r\n  // 2. RESEARCH ORCHESTRATOR ROUTING\r\n  // ==============================================================================\r\n  if (input.forceWebSearch || updatedState.conversationState === 'awaiting_practice_response') {\r\n      console.log(\"[üîç TRACE] Handing off to Research Orchestrator\");\r\n      \r\n      const researchResult = await runResearchOrchestrator({\r\n          query: input.text,\r\n          lastSearchTopic: updatedState.lastTopic,\r\n          forceWebSearch: input.forceWebSearch,\r\n          chatHistory: input.chatHistory.map(m => ({ role: m.role, content: m.content }))\r\n      });\r\n\r\n      updatedState.conversationState = 'general';\r\n      \r\n      let rawResponse = \r\n        (researchResult as any).reply || \r\n        (researchResult as any).response || \r\n        \"I checked, but I couldn't generate a clear answer. Let's try chatting about it directly.\";\r\n      \r\n      const sources = (researchResult as any).sources || [];\r\n      \r\n      // VIDEO HANDLING\r\n      if ((researchResult as any).videoData) {\r\n          const vData = (researchResult as any).videoData;\r\n          const currentContext = (updatedState.lastTopic || input.text).toLowerCase();\r\n          const videoTitleLower = (vData.title || \"\").toLowerCase();\r\n          \r\n          const stopWords = ['about', 'what', 'how', 'when', 'why', 'video', 'show', 'me'];\r\n          const topicKeywords = currentContext.split(' ').filter(w => w.length > 3 && !stopWords.includes(w));\r\n          \r\n          const isRelevant = topicKeywords.some(w => videoTitleLower.includes(w)) || videoTitleLower.includes(currentContext);\r\n\r\n          if (isRelevant && vData.id) {\r\n             videoData = vData;\r\n             const cleanTitle = (videoData!.title || \"Educational Video\").replace(/[\\[\\]]/g, '');\r\n             rawResponse += `\\n\\n[Watch Video: ${cleanTitle}](https://www.youtube.com/watch?v=${vData.id})`;\r\n          }\r\n      }\r\n\r\n      if ((researchResult as any).mode === 'teaching' || (researchResult as any).mode === 'web_research') {\r\n          updatedState.lastTopic = input.text;\r\n      }\r\n      \r\n      const sanitizedResponse = await GUARDIAN_SANITIZE(rawResponse, updatedState.lastTopic);\r\n      updatedState.lastAssistantMessage = sanitizedResponse;\r\n\r\n      return { \r\n          processedText: sanitizedResponse, \r\n          state: updatedState, \r\n          topic: updatedState.lastTopic, \r\n          sources: sources, \r\n          videoData: videoData, \r\n          suggestedTitle: suggestedTitle\r\n      };\r\n  }\r\n\r\n  // ==============================================================================\r\n  // 3. PRACTICE QUESTION LOGIC\r\n  // ==============================================================================\r\n  if (updatedState.awaitingPracticeQuestionAnswer) {\r\n      const isCorrect = validateAnswer(input.text, updatedState.correctAnswers || []);\r\n\r\n      if (isCorrect) {\r\n          const topic = updatedState.lastTopic || 'that';\r\n          responseText = `Excellent üåü! Mashallah, yes. You understand ${topic}. Ready for the next step?`;\r\n          updatedState.awaitingPracticeQuestionAnswer = false;\r\n          updatedState.validationAttemptCount = 0;\r\n          updatedState.activePracticeQuestion = undefined;\r\n          updatedState.correctAnswers = [];\r\n      } else {\r\n          updatedState.validationAttemptCount = (updatedState.validationAttemptCount || 0) + 1;\r\n          responseText = updatedState.validationAttemptCount > 1 \r\n            ? \"Let us take it slowly. Let's count together.\" \r\n            : \"Good try, but let's look closer.\";\r\n      }\r\n      \r\n      const sanitizedText = await GUARDIAN_SANITIZE(responseText, updatedState.lastTopic);\r\n      updatedState.lastAssistantMessage = sanitizedText;\r\n      return { processedText: sanitizedText, state: updatedState, suggestedTitle: suggestedTitle };\r\n  }\r\n\r\n  // ==============================================================================\r\n  // 4. DYNAMIC SYSTEM PROMPT (MULTILINGUAL GOVERNANCE)\r\n  // ==============================================================================\r\n  \r\n  const languageMode = input.preferences?.preferredLanguage || 'english';\r\n  \r\n  // ‚úÖ LOG GOVERNANCE LOADING (VERIFY STRICT RULES ARE ACTIVE)\r\n  console.log(`[GOVERNANCE] Loading Strict Rules for: ${languageMode}`);\r\n\r\n  // ‚úÖ NEW: Fetch Governed Prompt based on Language + Interests\r\n  const TEACHING_PROMPT = getLanguageGovernance(languageMode, rawInterests);\r\n\r\n  const RESEARCH_PROMPT = `\r\n  **IDENTITY**\r\n  Calm, neutral research assistant.\r\n  **RULES**\r\n  - Factual, clear, direct.\r\n  - No metaphors unless helpful.\r\n  - Direct answers.\r\n  `;\r\n\r\n  const isResearchIntent = input.text.toLowerCase().includes('search') || input.text.toLowerCase().includes('find') || input.forceWebSearch;\r\n  const systemMessage = isResearchIntent ? RESEARCH_PROMPT : TEACHING_PROMPT;\r\n\r\n  const messages: ChatCompletionMessageParam[] = [\r\n    { role: 'system', content: systemMessage },\r\n    ...input.chatHistory.map(msg => ({ \r\n      role: (msg.role === 'model' ? 'assistant' : msg.role) as 'user' | 'assistant', \r\n      content: msg.content \r\n    })),\r\n    { role: 'user', content: input.text },\r\n  ];\r\n\r\n  if (input.fileData) {\r\n      const lastMsgIndex = messages.length - 1;\r\n      if (messages[lastMsgIndex].role === 'user') {\r\n          messages[lastMsgIndex] = {\r\n              role: 'user',\r\n              content: [\r\n                  { type: 'text', text: input.text },\r\n                  { type: 'image_url', image_url: { url: `data:${input.fileData.type};base64,${input.fileData.base64}` } }\r\n              ]\r\n          };\r\n      }\r\n  }\r\n\r\n  // ==============================================================================\r\n  // 5. TOOLS & EXECUTION\r\n  // ==============================================================================\r\n  const tools = [\r\n    { type: 'function' as const, function: { name: 'ask_practice_question', description: 'Ask validation question.', parameters: { type: 'object' as const, properties: { question: { type: 'string' }, correctAnswers: { type: 'string' }, topic: { type: 'string' } }, required: ['question', 'correctAnswers', 'topic'] } } },\r\n    { type: 'function' as const, function: { name: 'youtube_search', description: 'Search educational video.', parameters: { type: 'object' as const, properties: { query: { type: 'string' } }, required: ['query'] } } },\r\n    { type: 'function' as const, function: { name: 'get_youtube_transcript', description: \"Fetch transcript.\", parameters: { type: 'object' as const, properties: { videoId: { type: 'string' } }, required: ['videoId'] } } },\r\n  ];\r\n\r\n  console.log('[BRAIN] Querying OpenAI...');\r\n  const completion = await openai.chat.completions.create({\r\n    messages: messages,\r\n    model: 'gpt-4o-mini',\r\n    tools: tools,\r\n    tool_choice: 'auto',\r\n  });\r\n\r\n  const responseMessage = completion.choices[0].message;\r\n\r\n  if (responseMessage.tool_calls && responseMessage.tool_calls.length > 0) {\r\n    const toolCall = responseMessage.tool_calls[0];\r\n    const functionName = (toolCall as any).function.name;\r\n    const args = JSON.parse((toolCall as any).function.arguments);\r\n\r\n    if (functionName === 'ask_practice_question') {\r\n        updatedState.awaitingPracticeQuestionAnswer = true;\r\n        updatedState.activePracticeQuestion = args.question;\r\n        updatedState.correctAnswers = args.correctAnswers.split(',').map((a: string) => a.trim().toLowerCase());\r\n        updatedState.lastTopic = args.topic;\r\n        updatedState.validationAttemptCount = 0;\r\n        responseText = `Here is a small challenge: What is (${updatedState.activePracticeQuestion})?`;\r\n    }\r\n\r\n    else if (functionName === 'youtube_search') {\r\n        try {\r\n            const results = await runFlow(youtubeSearchFlow, { query: args.query });\r\n            \r\n            if (results && results.length > 0) {\r\n                const video = results[0];\r\n                const currentTopic = updatedState.lastTopic || input.text;\r\n                const vidTitleLower = (video.title || \"\").toLowerCase();\r\n                const contextLower = currentTopic.toLowerCase();\r\n\r\n                // FUZZY MATCH\r\n                const stopWords = ['what', 'how', 'when', 'video', 'about'];\r\n                const keywords = contextLower.split(' ').filter(w => w.length > 3 && !stopWords.includes(w));\r\n                const isRelevant = keywords.some(k => vidTitleLower.includes(k)) || vidTitleLower.includes(contextLower);\r\n\r\n                if (isRelevant) {\r\n                    const safeChannel = (video.channel || video.channelTitle || '').replace('Unknown Channel', '');\r\n                    videoData = { id: video.id, title: video.title, channel: safeChannel, thumbnail: video.thumbnailUrl };\r\n                    \r\n                    const cleanTitle = (video.title || \"Video\").replace(/[\\[\\]]/g, '');\r\n                    // ‚úÖ Text Link Only\r\n                    responseText = `I found a great video for you: \"${video.title}\".\\n\\n[Watch Video: ${cleanTitle}](https://www.youtube.com/watch?v=${video.id})`;\r\n                } else {\r\n                    responseText = \"Let me explain this to you step by step myself!\";\r\n                }\r\n            } else {\r\n                responseText = \"Let's explore this topic directly together.\";\r\n            }\r\n        } catch (error) {\r\n            console.error('[BRAIN] Video Search Error:', error);\r\n            responseText = \"Let's just talk about this directly.\";\r\n        }\r\n    }\r\n\r\n    else if (functionName === 'get_youtube_transcript') {\r\n        if (!args.videoId) {\r\n            responseText = \"Let's discuss the topic directly!\";\r\n        } else {\r\n            const transcript = await runFlow(getYoutubeTranscriptFlow, args);\r\n            if (!transcript || transcript.startsWith('Could not')) {\r\n                responseText = `I can't access that transcript right now. What specific part would you like me to explain?`;\r\n            } else {\r\n                const safeTranscript = transcript.length > 50000 ? transcript.substring(0, 50000) + \"...\" : transcript;\r\n                const newMessages: ChatCompletionMessageParam[] = [ ...messages, responseMessage, { role: 'tool', tool_call_id: toolCall.id, content: safeTranscript } ];\r\n                const secondCompletion = await openai.chat.completions.create({ messages: newMessages, model: 'gpt-4o' });\r\n                responseText = secondCompletion.choices[0].message.content || \"I watched the video. What would you like to know?\";\r\n            }\r\n        }\r\n    }\r\n  } else {\r\n      responseText = responseMessage.content || \"I'm here to help!\";\r\n  }\r\n  \r\n  if (!updatedState.lastTopic && input.forceWebSearch) updatedState.lastTopic = input.text;\r\n\r\n  // Pass user interests to sanitizer for fine-tuning\r\n  const sanitizedFinalText = await GUARDIAN_SANITIZE(responseText, updatedState.lastTopic);\r\n  updatedState.lastAssistantMessage = sanitizedFinalText;\r\n\r\n  return { processedText: sanitizedFinalText, videoData, state: updatedState, topic: updatedState.lastTopic || input.text, suggestedTitle };\r\n};"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2933, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/ai/flows/personalize-daily-objectives.ts"],"sourcesContent":["// src/ai/flows/personalize-daily-objectives.ts\r\n'use server';\r\n/**\r\n * @fileOverview Generates personalized daily objectives for students based on their performance and the curriculum.\r\n *\r\n * - personalizedObjectives - A function that generates personalized daily objectives.\r\n * - PersonalizedObjectivesInput - The input type for the personalizedObjectives function.\r\n * - PersonalizedObjectivesOutput - The return type for the personalizedObjectives function.\r\n */\r\n\r\nimport { z } from 'genkit';\r\nimport OpenAI from 'openai';\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n  timeout: 30000, // 30 seconds\r\n});\r\n\r\nconst PersonalizedObjectivesInputSchema = z.object({\r\n  studentPerformance: z.string().describe('The student\\u2019s recent academic performance data.'),\r\n  curriculum: z.string().describe('The curriculum for the current lesson or day.'),\r\n  loggedMisconceptions: z.string().describe('Any misconceptions the student has demonstrated.'),\r\n});\r\nexport type PersonalizedObjectivesInput = z.infer<typeof PersonalizedObjectivesInputSchema>;\r\n\r\nconst PersonalizedObjectivesOutputSchema = z.object({\r\n  dailyObjectives: z.array(\r\n    z.string().describe('A list of 2-5 personalized daily objectives for the student.')\r\n  ).describe('An array of personalized daily objectives'),\r\n});\r\nexport type PersonalizedObjectivesOutput = z.infer<typeof PersonalizedObjectivesOutputSchema>;\r\n\r\nexport async function personalizedObjectives(input: PersonalizedObjectivesInput): Promise<PersonalizedObjectivesOutput> {\r\n  return personalizedObjectivesFlow(input);\r\n}\r\n\r\nconst personalizedObjectivesFlow = async (input: PersonalizedObjectivesInput): Promise<PersonalizedObjectivesOutput> => {\r\n  const systemMessage = `You are **Steadfast Copilot AI**, a supportive and insightful teacher for Kenyan students.\r\nYour task is to create a short, personalized list of daily objectives to help a student focus their learning for the day.\r\nThe objectives should be clear, encouraging, and directly related to their recent performance, the curriculum, and any misconceptions they have.\r\n\r\nKeep the objectives:\r\n- **Action-oriented:** Start with a verb (e.g., \"Review,\" \"Practice,\" \"Explain\").\r\n- **Specific:** Clearly state the topic or skill to work on.\r\n- **Positive and encouraging:** Frame the objectives in a way that builds confidence.\r\n- **Concise:** Generate between 2 to 4 objectives.\r\n\r\nHere is the student's information:\r\n- **Student Performance:** ${input.studentPerformance}\r\n- **Today's Curriculum:** ${input.curriculum}\r\n- **Logged Misconceptions:** ${input.loggedMisconceptions}\r\n\r\nBased on this, create a list of daily objectives.`;\r\n\r\n  const completion = await openai.chat.completions.create({\r\n    messages: [\r\n      { role: 'system', content: systemMessage },\r\n    ],\r\n    model: 'gpt-4o-mini',\r\n  });\r\n\r\n  const objectivesString = completion.choices[0].message.content || '';\r\n  const dailyObjectives = objectivesString.split('\\n').filter(obj => obj.trim() !== '');\r\n\r\n  return { dailyObjectives };\r\n};\r\n"],"names":[],"mappings":"AAAA,+CAA+C;;;;;;AAE/C;;;;;;CAMC,GAED;AAAA;AACA;AAAA;;;;;;AAEA,MAAM,SAAS,IAAI,sKAAA,CAAA,UAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;IAClC,SAAS;AACX;AAEA,MAAM,oCAAoC,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACjD,oBAAoB,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACxC,YAAY,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAChC,sBAAsB,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AAC5C;AAGA,MAAM,qCAAqC,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAClD,iBAAiB,uIAAA,CAAA,IAAC,CAAC,KAAK,CACtB,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,iEACpB,QAAQ,CAAC;AACb;AAGO,eAAe,uBAAuB,KAAkC;IAC7E,OAAO,2BAA2B;AACpC;AAEA,MAAM,6BAA6B,OAAO;IACxC,MAAM,gBAAgB,CAAC;;;;;;;;;;;2BAWE,EAAE,MAAM,kBAAkB,CAAC;0BAC5B,EAAE,MAAM,UAAU,CAAC;6BAChB,EAAE,MAAM,oBAAoB,CAAC;;iDAET,CAAC;IAEhD,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;QACtD,UAAU;YACR;gBAAE,MAAM;gBAAU,SAAS;YAAc;SAC1C;QACD,OAAO;IACT;IAEA,MAAM,mBAAmB,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;IAClE,MAAM,kBAAkB,iBAAiB,KAAK,CAAC,MAAM,MAAM,CAAC,CAAA,MAAO,IAAI,IAAI,OAAO;IAElF,OAAO;QAAE;IAAgB;AAC3B;;;IAjCsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 3020, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/AI/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport default prisma;\r\n"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;uCAEhB","debugId":null}},
    {"offset": {"line": 3033, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/app/actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { emotionalAICopilot } from '@/ai/flows/emotional-ai-copilot';\r\nimport { personalizedObjectives, PersonalizedObjectivesInput } from '@/ai/flows/personalize-daily-objectives';\r\nimport { youtubeSearchFlow } from '@/ai/flows/youtube-search-flow';\r\nimport { runFlow } from '@genkit-ai/flow';\r\nimport type { ConversationState, Message } from '@/lib/types';\r\nimport prisma from '@/lib/prisma';\r\nimport { cookies } from 'next/headers';\r\n\r\n/**\r\n * Helper to save message to DB (mimics backend logic)\r\n */\r\nasync function saveMessageToDb(sessionId: string, role: 'user' | 'model', content: string) {\r\n  try {\r\n    if (!sessionId) return;\r\n\r\n    const sessionExists = await prisma.chatSession.findUnique({\r\n        where: { id: sessionId },\r\n        select: { id: true }\r\n    });\r\n\r\n    if (!sessionExists) {\r\n        return; \r\n    }\r\n\r\n    const count = await prisma.chatMessage.count({ where: { sessionId } });\r\n    await prisma.chatMessage.create({\r\n      data: {\r\n        sessionId,\r\n        role,\r\n        content,\r\n        timestamp: new Date(),\r\n        messageNumber: count + 1,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    // console.error('Error saving message to DB:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to update session state and title\r\n */\r\nasync function updateSessionState(sessionId: string, state: ConversationState, topic?: string, title?: string) {\r\n  if (!sessionId) return;\r\n  \r\n  // üîç LOGGING: Checking what we are trying to save\r\n  console.log(`[ACTION LOG] Attempting DB Update. ID: ${sessionId}, Title: \"${title}\"`);\r\n\r\n  const data: any = { updatedAt: new Date(), metadata: state };\r\n  \r\n  // ‚úÖ UPDATE TITLE IF PROVIDED\r\n  if (title && title !== \"New Chat\") {\r\n      data.topic = title; // Map 'title' to 'topic' column\r\n  }\r\n  \r\n  // UPDATE INTERNAL TOPIC (If separate from title)\r\n  if (topic && !title) {\r\n      data.topic = topic;\r\n  }\r\n  \r\n  await prisma.chatSession.update({\r\n    where: { id: sessionId },\r\n    data,\r\n  });\r\n}\r\n\r\n// FETCH MEMORY HELPER\r\nasync function fetchStudentMemory() {\r\n  try {\r\n    return { progress: [], mistakes: [] };\r\n  } catch (e) {\r\n    return { progress: [], mistakes: [] };\r\n  }\r\n}\r\n\r\nexport async function getAssistantResponse(\r\n  sessionId: string,\r\n  message: string,\r\n  chatHistory: Message[],\r\n  currentState: ConversationState,\r\n  fileDataBase64: { type: string; base64: string } | undefined,\r\n  forceWebSearch: boolean,\r\n  includeVideos: boolean,\r\n  preferences: {\r\n    name?: string;\r\n    gradeLevel?: 'Primary' | 'LowerSecondary' | 'UpperSecondary';\r\n    preferredLanguage?: 'english' | 'swahili' | 'arabic' | 'english_sw';\r\n    interests?: string[];\r\n  },\r\n  studentMemory: {\r\n    progress: any[];\r\n    mistakes: any[];\r\n  }\r\n) {\r\n  try {\r\n    // 1. Save User Message (Safely)\r\n    if (sessionId) {\r\n        await saveMessageToDb(sessionId, 'user', message);\r\n    }\r\n\r\n    // ‚úÖ FETCH CURRENT TITLE TO PASS TO AI\r\n    // This allows the AI to know if it needs to generate a title (if current is 'New Chat')\r\n    let currentTitle = 'New Chat';\r\n    if (sessionId) {\r\n        try {\r\n            const currentSession = await prisma.chatSession.findUnique({\r\n                where: { id: sessionId },\r\n                select: { topic: true }\r\n            });\r\n            if (currentSession?.topic) {\r\n                currentTitle = currentSession.topic;\r\n            }\r\n        } catch (e) {\r\n            // Ignore DB read error, default to New Chat\r\n        }\r\n    }\r\n\r\n    // 2. Run AI\r\n    console.log(\"[ACTION LOG] Calling Emotional AI...\");\r\n    const response = await emotionalAICopilot({\r\n      text: message,\r\n      chatHistory: chatHistory,\r\n      state: currentState,\r\n      preferences: preferences,\r\n      fileData: fileDataBase64,\r\n      forceWebSearch,\r\n      includeVideos,\r\n      memory: studentMemory,\r\n      currentTitle: currentTitle,\r\n      studentProfile: {\r\n        name: preferences.name || 'Student', // Ensure name is passed\r\n        gradeLevel: preferences.gradeLevel || 'Primary' // Ensure grade is passed\r\n      }\r\n    });\r\n\r\n    console.log(`[ACTION LOG] AI Finished. Suggested Title: \"${response.suggestedTitle}\"`);\r\n\r\n    // 3. Save AI Response & Try Update Title\r\n    if (sessionId) {\r\n        await saveMessageToDb(sessionId, 'model', response.processedText);\r\n        \r\n        // üõ°Ô∏è CRITICAL FIX: TRY/CATCH AROUND DB UPDATE\r\n        try {\r\n            await updateSessionState(\r\n                sessionId, \r\n                response.state, \r\n                response.topic, \r\n                response.suggestedTitle \r\n            );\r\n        } catch (dbError) {\r\n            console.warn(\"‚ö†Ô∏è [ACTION LOG] DB Write Failed (RLS/Auth). Returning title to Client for fallback save.\");\r\n        }\r\n    }\r\n\r\n    return {\r\n      processedText: response.processedText,\r\n      videoData: response.videoData ?? undefined,\r\n      state: response.state,\r\n      // ‚úÖ VITAL FIX: Pass suggestedTitle as 'topic' so frontend detects it\r\n      topic: response.suggestedTitle || response.topic,\r\n      suggestedTitle: response.suggestedTitle \r\n    };\r\n  } catch (err) {\r\n    console.error('[SERVER ACTION FATAL ERROR]', err);\r\n    return {\r\n      processedText: 'I am sorry, but something went wrong while processing that. Could you try again?',\r\n      videoData: undefined,\r\n      state: currentState,\r\n      topic: undefined,\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getDailyObjectives(\r\n  studentPerformance: string,\r\n  curriculum: string,\r\n  loggedMisconceptions: string\r\n) {\r\n  try {\r\n    const objectivesInput: PersonalizedObjectivesInput = {\r\n      studentPerformance,\r\n      curriculum,\r\n      loggedMisconceptions,\r\n    };\r\n    const result = await personalizedObjectives(objectivesInput);\r\n    return result.dailyObjectives;\r\n  } catch (err) {\r\n    console.error('[SERVER ACTION BRIDGE ERROR - Objectives]', err);\r\n    return ['Review today\\'s key concepts.', 'Practice one core problem.'];\r\n  }\r\n}\r\n\r\nexport async function searchYouTube(query: string) {\r\n  try {\r\n    const results = await runFlow(youtubeSearchFlow, { query });\r\n    return results;\r\n  } catch (error) {\r\n    console.error('[SERVER ACTION BRIDGE ERROR - YouTube]', error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport type { ConversationState, Message };"],"names":[],"mappings":";;;;;;;AAEA;AACA;AACA;AACA;AAAA;AAEA;;;;;;;;;AAGA;;CAEC,GACD,eAAe,gBAAgB,SAAiB,EAAE,IAAsB,EAAE,OAAe;IACvF,IAAI;QACF,IAAI,CAAC,WAAW;QAEhB,MAAM,gBAAgB,MAAM,mHAAA,CAAA,UAAM,CAAC,WAAW,CAAC,UAAU,CAAC;YACtD,OAAO;gBAAE,IAAI;YAAU;YACvB,QAAQ;gBAAE,IAAI;YAAK;QACvB;QAEA,IAAI,CAAC,eAAe;YAChB;QACJ;QAEA,MAAM,QAAQ,MAAM,mHAAA,CAAA,UAAM,CAAC,WAAW,CAAC,KAAK,CAAC;YAAE,OAAO;gBAAE;YAAU;QAAE;QACpE,MAAM,mHAAA,CAAA,UAAM,CAAC,WAAW,CAAC,MAAM,CAAC;YAC9B,MAAM;gBACJ;gBACA;gBACA;gBACA,WAAW,IAAI;gBACf,eAAe,QAAQ;YACzB;QACF;IACF,EAAE,OAAO,OAAO;IACd,uDAAuD;IACzD;AACF;AAEA;;CAEC,GACD,eAAe,mBAAmB,SAAiB,EAAE,KAAwB,EAAE,KAAc,EAAE,KAAc;IAC3G,IAAI,CAAC,WAAW;IAEhB,kDAAkD;IAClD,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,UAAU,UAAU,EAAE,MAAM,CAAC,CAAC;IAEpF,MAAM,OAAY;QAAE,WAAW,IAAI;QAAQ,UAAU;IAAM;IAE3D,6BAA6B;IAC7B,IAAI,SAAS,UAAU,YAAY;QAC/B,KAAK,KAAK,GAAG,OAAO,gCAAgC;IACxD;IAEA,iDAAiD;IACjD,IAAI,SAAS,CAAC,OAAO;QACjB,KAAK,KAAK,GAAG;IACjB;IAEA,MAAM,mHAAA,CAAA,UAAM,CAAC,WAAW,CAAC,MAAM,CAAC;QAC9B,OAAO;YAAE,IAAI;QAAU;QACvB;IACF;AACF;AAEA,sBAAsB;AACtB,eAAe;IACb,IAAI;QACF,OAAO;YAAE,UAAU,EAAE;YAAE,UAAU,EAAE;QAAC;IACtC,EAAE,OAAO,GAAG;QACV,OAAO;YAAE,UAAU,EAAE;YAAE,UAAU,EAAE;QAAC;IACtC;AACF;AAEO,eAAe,qBACpB,SAAiB,EACjB,OAAe,EACf,WAAsB,EACtB,YAA+B,EAC/B,cAA4D,EAC5D,cAAuB,EACvB,aAAsB,EACtB,WAKC,EACD,aAGC;IAED,IAAI;QACF,gCAAgC;QAChC,IAAI,WAAW;YACX,MAAM,gBAAgB,WAAW,QAAQ;QAC7C;QAEA,sCAAsC;QACtC,wFAAwF;QACxF,IAAI,eAAe;QACnB,IAAI,WAAW;YACX,IAAI;gBACA,MAAM,iBAAiB,MAAM,mHAAA,CAAA,UAAM,CAAC,WAAW,CAAC,UAAU,CAAC;oBACvD,OAAO;wBAAE,IAAI;oBAAU;oBACvB,QAAQ;wBAAE,OAAO;oBAAK;gBAC1B;gBACA,IAAI,gBAAgB,OAAO;oBACvB,eAAe,eAAe,KAAK;gBACvC;YACJ,EAAE,OAAO,GAAG;YACR,4CAA4C;YAChD;QACJ;QAEA,YAAY;QACZ,QAAQ,GAAG,CAAC;QACZ,MAAM,WAAW,MAAM,CAAA,GAAA,+IAAA,CAAA,qBAAkB,AAAD,EAAE;YACxC,MAAM;YACN,aAAa;YACb,OAAO;YACP,aAAa;YACb,UAAU;YACV;YACA;YACA,QAAQ;YACR,cAAc;YACd,gBAAgB;gBACd,MAAM,YAAY,IAAI,IAAI;gBAC1B,YAAY,YAAY,UAAU,IAAI,UAAU,yBAAyB;YAC3E;QACF;QAEA,QAAQ,GAAG,CAAC,CAAC,4CAA4C,EAAE,SAAS,cAAc,CAAC,CAAC,CAAC;QAErF,yCAAyC;QACzC,IAAI,WAAW;YACX,MAAM,gBAAgB,WAAW,SAAS,SAAS,aAAa;YAEhE,+CAA+C;YAC/C,IAAI;gBACA,MAAM,mBACF,WACA,SAAS,KAAK,EACd,SAAS,KAAK,EACd,SAAS,cAAc;YAE/B,EAAE,OAAO,SAAS;gBACd,QAAQ,IAAI,CAAC;YACjB;QACJ;QAEA,OAAO;YACL,eAAe,SAAS,aAAa;YACrC,WAAW,SAAS,SAAS,IAAI;YACjC,OAAO,SAAS,KAAK;YACrB,qEAAqE;YACrE,OAAO,SAAS,cAAc,IAAI,SAAS,KAAK;YAChD,gBAAgB,SAAS,cAAc;QACzC;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;YACL,eAAe;YACf,WAAW;YACX,OAAO;YACP,OAAO;QACT;IACF;AACF;AAEO,eAAe,mBACpB,kBAA0B,EAC1B,UAAkB,EAClB,oBAA4B;IAE5B,IAAI;QACF,MAAM,kBAA+C;YACnD;YACA;YACA;QACF;QACA,MAAM,SAAS,MAAM,CAAA,GAAA,uJAAA,CAAA,yBAAsB,AAAD,EAAE;QAC5C,OAAO,OAAO,eAAe;IAC/B,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6CAA6C;QAC3D,OAAO;YAAC;YAAiC;SAA6B;IACxE;AACF;AAEO,eAAe,cAAc,KAAa;IAC/C,IAAI;QACF,MAAM,UAAU,MAAM,CAAA,GAAA,qJAAA,CAAA,UAAO,AAAD,EAAE,8IAAA,CAAA,oBAAiB,EAAE;YAAE;QAAM;QACzD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0CAA0C;QACxD,OAAO,EAAE;IACX;AACF;;;IA7HsB;IAkGA;IAmBA;;AArHA,+OAAA;AAkGA,+OAAA;AAmBA,+OAAA","debugId":null}},
    {"offset": {"line": 3242, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getAssistantResponse as '7ffb0850d8356f1302247d1a1a0765dd4d440d4972'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 3294, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/components/ui/avatar.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport const Avatar = registerClientReference(\n    function() { throw new Error(\"Attempted to call Avatar() from the server but Avatar is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx <module evaluation>\",\n    \"Avatar\",\n);\nexport const AvatarFallback = registerClientReference(\n    function() { throw new Error(\"Attempted to call AvatarFallback() from the server but AvatarFallback is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx <module evaluation>\",\n    \"AvatarFallback\",\n);\nexport const AvatarImage = registerClientReference(\n    function() { throw new Error(\"Attempted to call AvatarImage() from the server but AvatarImage is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx <module evaluation>\",\n    \"AvatarImage\",\n);\n"],"names":[],"mappings":";;;;;AAAA;;AACO,MAAM,SAAS,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACxC;IAAa,MAAM,IAAI,MAAM;AAA4N,GACzP,mEACA;AAEG,MAAM,iBAAiB,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAChD;IAAa,MAAM,IAAI,MAAM;AAA4O,GACzQ,mEACA;AAEG,MAAM,cAAc,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAC7C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,mEACA","debugId":null}},
    {"offset": {"line": 3316, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/components/ui/avatar.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport const Avatar = registerClientReference(\n    function() { throw new Error(\"Attempted to call Avatar() from the server but Avatar is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx\",\n    \"Avatar\",\n);\nexport const AvatarFallback = registerClientReference(\n    function() { throw new Error(\"Attempted to call AvatarFallback() from the server but AvatarFallback is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx\",\n    \"AvatarFallback\",\n);\nexport const AvatarImage = registerClientReference(\n    function() { throw new Error(\"Attempted to call AvatarImage() from the server but AvatarImage is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/frontend/components/ui/avatar.tsx\",\n    \"AvatarImage\",\n);\n"],"names":[],"mappings":";;;;;AAAA;;AACO,MAAM,SAAS,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACxC;IAAa,MAAM,IAAI,MAAM;AAA4N,GACzP,+CACA;AAEG,MAAM,iBAAiB,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAChD;IAAa,MAAM,IAAI,MAAM;AAA4O,GACzQ,+CACA;AAEG,MAAM,cAAc,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAC7C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,+CACA","debugId":null}},
    {"offset": {"line": 3338, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 3348, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/components/header.tsx"],"sourcesContent":["import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { Bot } from 'lucide-react';\r\n\r\nexport function Header() {\r\n  return (\r\n    <header className=\"sticky top-0 z-20 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\r\n      <div className=\"container flex h-14 max-w-screen-2xl items-center justify-between px-4\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary\">\r\n            <Bot className=\"h-5 w-5 text-primary-foreground\" />\r\n          </div>\r\n          <h1 className=\"text-lg font-bold tracking-tight\">Steadfast Copilot AI</h1>\r\n        </div>\r\n        <div className=\"flex items-center gap-4\">\r\n           <span className=\"text-sm font-medium text-muted-foreground hidden sm:inline\">Jane Doe</span>\r\n          <Avatar className=\"h-9 w-9\">\r\n            <AvatarImage src=\"https://picsum.photos/100/100\" alt=\"Student avatar\" data-ai-hint=\"student avatar\" />\r\n            <AvatarFallback>JD</AvatarFallback>\r\n          </Avatar>\r\n        </div>\r\n      </div>\r\n    </header>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;AAEO,SAAS;IACd,qBACE,8OAAC;QAAO,WAAU;kBAChB,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAI,WAAU;sCACb,cAAA,8OAAC,gMAAA,CAAA,MAAG;gCAAC,WAAU;;;;;;;;;;;sCAEjB,8OAAC;4BAAG,WAAU;sCAAmC;;;;;;;;;;;;8BAEnD,8OAAC;oBAAI,WAAU;;sCACZ,8OAAC;4BAAK,WAAU;sCAA6D;;;;;;sCAC9E,8OAAC,uIAAA,CAAA,SAAM;4BAAC,WAAU;;8CAChB,8OAAC,uIAAA,CAAA,cAAW;oCAAC,KAAI;oCAAgC,KAAI;oCAAiB,gBAAa;;;;;;8CACnF,8OAAC,uIAAA,CAAA,iBAAc;8CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAM5B","debugId":null}},
    {"offset": {"line": 3454, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Steadfast-AI/frontend/app/page.tsx"],"sourcesContent":["\r\nimport { Header } from '@/components/header';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { BookOpen, Lightbulb } from 'lucide-react';\r\nimport Image from 'next/image';\r\nimport { DailyObjectives } from '@/components/daily-objectives';\r\n\r\nexport default function Home() {\r\n  return (\r\n    <>\r\n      <Header />\r\n      <main className=\"flex-1 p-4 sm:p-6 md:p-8\">\r\n        <div className=\"mx-auto max-w-4xl\">\r\n          <div className=\"mb-8\">\r\n            <h1 className=\"text-3xl font-bold tracking-tight\">Student Dashboard</h1>\r\n            <p className=\"text-muted-foreground\">Welcome back, let's continue your learning journey!</p>\r\n          </div>\r\n\r\n          {/* <DailyObjectives /> */}\r\n\r\n          {/* <Card className=\"mb-8 overflow-hidden\">\r\n             ... Image and content ...\r\n          </Card> */}\r\n        </div>\r\n      </main>\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AACA;;;AAOe,SAAS;IACtB,qBACE;;0BACE,8OAAC,iIAAA,CAAA,SAAM;;;;;0BACP,8OAAC;gBAAK,WAAU;0BACd,cAAA,8OAAC;oBAAI,WAAU;8BACb,cAAA,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAG,WAAU;0CAAoC;;;;;;0CAClD,8OAAC;gCAAE,WAAU;0CAAwB;;;;;;;;;;;;;;;;;;;;;;;;AAYjD","debugId":null}}]
}