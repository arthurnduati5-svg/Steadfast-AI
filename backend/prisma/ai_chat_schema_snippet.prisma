generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------------------------------------------------------
// AI CHAT MODELS (same as before)
// ---------------------------------------------------------
model ChatMessage {
  id            String      @id @default(uuid())
  sessionId     String
  chatSession   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          String
  content       String      @db.Text
  timestamp     DateTime    @default(now())
  messageNumber Int
  metadata      Json?

  @@index([sessionId])
  @@index([timestamp])
  @@map("ai_chat_messages")
}

model ChatSession {
  id          String         @id @default(uuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  startTime   DateTime       @default(now())
  endTime     DateTime?
  topic       String?
  isActive    Boolean        @default(true)
  messages    ChatMessage[]
  metadata    Json?

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([studentId])
  @@index([startTime])
  @@map("ai_chat_sessions")
}

// ---------------------------------------------------------
// STUDENT-LEVEL MEMORY
// ---------------------------------------------------------
model Progress {
  id         String         @id @default(uuid())
  studentId  String
  student    StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  subject    String
  topic      String
  mastery    Int
  updatedAt  DateTime       @updatedAt

  @@index([studentId, subject, topic])
  @@map("ai_student_progress")
}

model Mistake {
  id         String         @id @default(uuid())
  studentId  String
  student    StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  topic      String
  error      String
  attempts   Int            @default(1)
  lastSeen   DateTime       @default(now())

  @@index([studentId, topic])
  @@map("ai_student_mistakes")
}

// ---------------------------------------------------------
// GLOBAL AI MEMORY
// ---------------------------------------------------------
model GlobalMemory {
  id         String   @id @default(uuid())
  topic      String
  question   String
  correction String
  frequency  Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([topic])
  @@map("ai_global_memory")
}
